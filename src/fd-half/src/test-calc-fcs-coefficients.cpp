#include "Common.h"
#include "Gamma.h"
#include "Logger.h"
#include "FileSys.h"

/**
 * всюду сходящийся ряд, расчет b_n_k
 * Формулы Эйлера-Маклорена(формула трапеций), равномерная сетка
 */
namespace {
    // Подынтегральная функция
    BmpReal f(size_t n, const BmpReal& tau) {
        BmpReal mul = pow(1 - 2*exp(-tau*tau), n);
        return mul*exp(-tau*tau);
    }

    // Формула трапеций
    BmpReal trapz(size_t n, const BmpReal& P) {
        BmpReal F = 0;
        BmpReal h = 8.0 / P;
        for (size_t p = P - 1; p > 0; --p) {
            F += f(n, 8*p/P);
        }
        return (2*F + pow(-1, n))*h;
    }

    // Вычисление коэффициентов по методу, близкому к Ричардсону(сверхстепенная сходимость)
    BmpReal calculateBm12(size_t N) {
        BmpReal k = -0.5;
        BmpReal P0 = 8.0;
        BmpReal I2n, In, stopCriteria;
        do {
            In = trapz(N, P0);
            I2n = trapz(N, 2 * P0);
            P0 *= 2;
            stopCriteria = abs(I2n - In);
        } while (stopCriteria > 1e-14);
        std::cout << P0 << std::endl;
        return I2n / factorial(k);
    }

    // Вычисление по реккурентной формуле
    BmpVector calculateBk(const BmpVector& Bkm1) {
        BmpVector Bk;
        size_t N = Bkm1.size();
        BmpReal value = 0;
        for (size_t i = 0; i < N; ++i) {
            value += Bkm1.at(i);
            Bk.push_back(value / (i + 1));
        }
        return Bk;
    }
}

TEST_CASE("mHalf") {
    BmpVector bm12;
    for (size_t N = 0; N <= 67; ++N) {
        bm12.push_back(calculateBm12(N));
    }
    filesys::writeFile("bm12.txt", bm12);
}

TEST_CASE("half") {
    const BmpVector B_m12 = {
        1.0000000000000000, -0.41421356237309515, 0.48097395201231308, -0.31443745684377605, 0.35496973905796525, -0.2639146991274261, 0.29305220065772453,
       -0.23206012422784597, 0.25480909731988405, -0.20961507725316636, 0.22827198241767724, -0.19269402581588935, 0.20850412514677033, -0.17934271566143664,
        0.19305732762114028, -0.16845640223916253, 0.1805638658684417 , -0.15935707527675091, 0.17019275877281642, -0.15160238383284011, 0.16140657992677773,
       -0.14488973151960657, 0.15384051431503362, -0.13900414944762135, 0.1472371586201546 , -0.13378812964569098, 0.14140906612540924, -0.12912325802251828,
        0.13621609350926644, -0.12491855193815647, 0.13155110392581695, -0.12110278860777168, 0.12733061461119022, -0.11761930413804721, 0.12348848883008756,
       -0.11442237441589655, 0.11997156715133331, -0.11147463877385461, 0.11673657115056887, -0.10874522884795892, 0.11374786384105723, -0.10620838520960593,
        0.11097580026521373, -0.10384241822419096, 0.10839549296611649, -0.10162891623985279, 0.10598587447494355, -0.09955213438673234, 0.10372897595078695,
       -0.09759851721451281, 0.10160936547917465, -0.09575632184163210, 0.099613705906352476, -0.09401531751504925, 0.097730403282552378, -0.09236654391281224,
        0.095949324771059719, -0.09080211507512911, 0.094261570372856804, -0.08931505911688105, 0.092659286746943334, -0.08789918624863347, 0.091135514254736275,
        -0.08654897937862024, 0.089684060445614291, -0.08525950286539473, 0.088299394749181859, -0.08402632596474541,
    };

    BmpVector b12 = calculateBk(B_m12);
    filesys::writeFile("b12.txt", b12);
}

TEST_CASE("3half") {
    const BmpVector B12 = {
        1.00000000000000000, 0.29289321881345243, 0.35558679654640596, 0.18808073319886048, 0.22145853437068147, 0.14056299545433018, 0.16234716762624365,
        0.11304625614448247, 0.12879768294174931, 0.09495640692225774, 0.10707600469456860, 0.08209516881869711, 0.09181893469008735,
        0.07245024537926421, 0.08049071752872261, 0.06493152254322979, 0.07173342509177166, 0.05889506396018707, 0.06475283737137809, 0.05393507631116717,
        0.05905276695952958, 0.04978265339229612, 0.05430690821502384, 0.04625228081241362, 0.05029167592472326, 0.04321168340278425, 0.04684862350362221,
        0.04056391344911719, 0.04386226448567407, 0.03823623727154638, 0.04124639426039382, 0.03617298229576366, 0.03893533479017052, 0.03433078658639941,
        0.03687814950764765, 0.03267535717643808, 0.03503471420278660, 0.03117920491392763, 0.03337298353537996, 0.02982002822579649, 0.03186704860665650,
        0.02857953827769788, 0.03049573041694243, 0.02744259067509849, 0.02924154405934333, 0.02639653405283907, 0.02808992427458597, 0.02543071471914185,
        0.02702863841774685, 0.02453609530510165, 0.02604733589675014, 0.02370495786331971, 0.02513719839243354, 0.02293067032007274, 0.02429066546484510,
        0.02220750101167265, 0.02350121721797768, 0.02153047010947584, 0.02276320062241450, 0.02089522962675958, 0.02207168957954948, 0.02029796577586911,
        0.02142237130727970, 0.01973531895281251, 0.02081145343731716, 0.01920431773576092, 0.02023558754193138, 0.01870232410800966,
    };

    BmpVector b32 = calculateBk(B12);
    filesys::writeFile("b32.txt", b32);
}

TEST_CASE("5half") {
    const BmpVector B32 = {
        1.00000000000000000, 0.64644660940672627, 0.54949333845328618, 0.45914018713967975, 0.41160385658588011, 0.36643037973062181, 0.33727563514428205,
        0.30924696276930708, 0.28919704278846736, 0.26977297920184640, 0.25498234515573021, 0.24057508046097745, 0.22913230001706283, 0.21794072468579154,
        0.20877739087532027, 0.19978702410456461, 0.19225445945675326, 0.18484560415138848, 0.17852493221559845, 0.17229543942037689, 0.16690293120795557,
        0.16157928221633469, 0.15691526595540814, 0.15230430824111671,0.14822380294846099, 0.14418487527362728, 0.14057982891177523, 0.13700783193096602,
        0.13379591581216285, 0.13061059319414231, 0.12772787709950525, 0.12486678663688833, 0.12226280324759384, 0.11967656746344106, 0.11731089837898982,
        0.11495991112336339, 0.11279977066605049, 0.11065186104099461, 0.10867035136136348, 0.10669909328297431, 0.10487392146160071, 0.10305738852865064,
        0.10136990810744811, 0.09968974180216744, 0.09812422629677135, 0.09656492863929457, 0.09510801365281142, 0.09365640325835996, 0.09229665295549030,
        0.09094144180248254, 0.08966900835335054, 0.08840046892084995, 0.08720682230710623, 0.08601652319623525, 0.08489423487384633, 0.08377482891202180,
        0.08271739712791576, 0.08166245011035646, 0.08066415774615404, 0.07966800894416413, 0.07872380698736717, 0.07778145470976236, 0.07688686608432613,
        0.07599387316039623, 0.07514491285696424, 0.07429732808240055, 0.07349043643254280, 0.07268472889835849,
    };

    BmpVector b52 = calculateBk(B32);
    filesys::writeFile("b52.txt", b52);
}

TEST_CASE("7half") {
    const BmpVector B52 = {
        1.00000000000000000, 0.82322330470336313, 0.73197998262000408,0.66377003374992305, 0.61333679831711441, 0.57218572855269900, 0.53862714378006804,
        0.50995462115372292, 0.48542600133536123, 0.46386069912200972, 0.44487175785234795, 0.42784703473640034, 0.41256128591183594, 0.39865981725283278,
        0.38600098882766526, 0.37436261603247145, 0.36365037152801749, 0.35371677334042695, 0.34449615012333074, 0.33588611458818302, 0.32783929633198172,
        0.32028202296308866, 0.31317912048449387, 0.30647600330768648, 0.30014591529331747, 0.29414741375409864, 0.28845972542660520, 0.28305072923033237,
        0.27790401152625754, 0.27299423091518704, 0.26830821950177797, 0.26382567472475016, 0.25953589074059391, 0.25542238123244237, 0.25147633886520088,
        0.24768421587237210, 0.24403869032625530, 0.24052851060822211, 0.23714753216599496, 0.23388632119391944,0.23073967729800923, 0.22769962280350070,
        0.22476172246173204, 0.22191917744674194, 0.21916817853229817, 0.21650289049114591, 0.21392002077118136, 0.21141452873966424, 0.20898355168284435,
        0.20662270948523712, 0.20432949965912170, 0.20210009522184727, 0.19993229761968234, 0.19782274624147037, 0.19576950058024084, 0.19376959572902264,
        0.19182131154303830, 0.18992202082868170, 0.18807019264084227, 0.18626348957923095, 0.18450054396297091, 0.18277926832985464, 0.18109843654817959,
        0.17945617774524547, 0.17785138905465653, 0.17628238813083447, 0.17474817989653160, 0.17324724679361730,
    };

    BmpVector b72 = calculateBk(B52);
    filesys::writeFile("b72.txt", b72);
}
