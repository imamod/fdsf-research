%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 3/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.01708452577902084
0.03416905155804167
0.05125357733706251
0.06833810311608335
0.08542262889510419
0.10250715467412502
0.11959168045314586
0.13667620623216670
0.15376073201118753
0.17084525779020837
0.18792978356922921
0.21461084402001832
0.24129190447080742
0.26797296492159650
0.29465402537238561
0.32133508582317472
0.34801614627396382
0.37469720672475293
0.40137826717554204
0.42805932762633114
0.45474038807712025
0.48142144852790936
0.51592567572056169
0.55042990291321403
0.58493413010586637
0.61943835729851870
0.65394258449117104
0.68844681168382338
0.72295103887647572
0.75745526606912805
0.79195949326178039
0.82646372045443273
0.86096794764708506
0.90057838428498249
0.94018882092287992
0.97979925756077735
1.01940969419867478
1.05902013083657232
1.09863056747446985
1.13824100411236739
1.17785144075026493
1.21746187738816247
1.25707231402606001
1.29668275066395755
1.33806655523175988
1.37945035979956221
1.42083416436736454
1.46221796893516687
1.50360177350296920
1.54498557807077153
1.58636938263857386
1.62775318720637618
1.66913699177417851
1.71052079634198084
1.75190460090978317
1.79151503754768071
1.83112547418557825
1.87073591082347579
1.91034634746137333
1.94995678409927087
1.98956722073716841
2.02917765737506572
2.06878809401296326
2.10839853065086080
2.14800896728875834
2.18761940392665588
2.22212363111930822
2.25662785831196055
2.29113208550461289
2.32563631269726523
2.36014053988991757
2.39464476708256990
2.42914899427522224
2.46365322146787458
2.49815744866052691
2.53266167585317925
2.56716590304583159
2.59384696349662081
2.62052802394741002
2.64720908439819924
2.67389014484898846
2.70057120529977768
2.72725226575056690
2.75393332620135611
2.78061438665214533
2.80729544710293455
2.83397650755372377
2.86065756800451299
2.87774209378353385
2.89482661956255471
2.91191114534157558
2.92899567112059644
2.94608019689961731
2.96316472267863817
2.98024924845765904
2.99733377423667990
3.01441830001570077
3.03150282579472163
3.04858735157374250
]';

X = log(exp(Y)-1); 

I_base = [0.26548025086247318
0.74781340390612949
1.51123876696233861
2.61438798352428137
4.07024811164968980
5.79948019063762477
7.60812415613680670
9.21870722762515626
10.35371486476145009
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.02283692238346405
0.04592682695758464
0.06927187737025842
0.09287424670761618
0.11673611742507897
0.14085968127729750
0.16524713924699988
0.18990070147274846
0.21482258717562791
0.24001502458487683
0.26548025086247318
0.30580053063748203
0.34680020292942032
0.38848791682389050
0.43087237214834290
0.47396231871280681
0.51776655553722184
0.56229393006574113
0.60755333736841222
0.65355371933061701
0.70030406383069066
0.74781340390612971
0.81039320149136174
0.87427726277610140
0.93948544573197557
1.00603772356261767
1.07395418148168509
1.14325501345169345
1.21396051888644552
1.28609109931989263
1.35966725504424768
1.43470958172023533
1.51123876696233839
1.60095342749408043
1.69268653717193551
1.78646980693250135
1.88233508156404916
1.98031433272920676
2.08043965197285274
2.18274324372265527
2.28725741828960016
2.39401458487577701
2.50304724459656791
2.61438798352428137
2.73321427585500576
2.85463292833338800
2.97868135053323035
3.10539701979424665
3.23481747282936594
3.36698029741167515
3.50192312414894991
3.63968361835338383
3.78029947201388872
3.92380839587793373
4.07024811164968625
4.21319255970163020
4.35888964002015733
4.50737241961725132
4.65867395010389274
4.81282726194814980
4.96986535884765868
5.12982121221974374
5.29272775581207622
5.45861788043660390
5.62752442882926118
5.79948019063762032
5.95177947806993135
6.10643893214380817
6.26348011079149192
6.42292453124707485
6.58479366784407016
6.74910894987242660
6.91589175949531931
7.08516342972585988
7.25694524246385519
7.43125842659277769
7.60812415613679782
7.74665242941929666
7.88672935408115716
8.02836464904700442
8.17156801146169087
8.31634911625403106
8.46271761571325598
8.61068313907795968
8.76025529213767129
8.91144365684676210
9.06425779095080131
9.21870722762515982
9.31846812964083959
9.41890592007543681
9.52002308554266463
9.62182210834051155
9.72430546641760429
9.82747563334047491
9.93133507826156325
10.03588626588807564
10.14113165645161274
10.24707370567858788
10.35371486476145364
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');