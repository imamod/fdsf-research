%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 5;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.01323015957699280
0.02646031915398560
0.03969047873097840
0.05292063830797120
0.06615079788496400
0.07938095746195681
0.09261111703894961
0.10584127661594242
0.11907143619293523
0.13230159576992803
0.14553175534692084
0.16534349737323148
0.18515523939954212
0.20496698142585276
0.22477872345216340
0.24459046547847405
0.26440220750478471
0.28421394953109536
0.30402569155740600
0.32383743358371664
0.34364917561002728
0.36346091763633792
0.38904318601288412
0.41462545438943033
0.44020772276597653
0.46578999114252273
0.49137225951906893
0.51695452789561513
0.54253679627216134
0.56811906464870754
0.59370133302525374
0.61928360140179994
0.64486586977834615
0.67494011467979120
0.70501435958123626
0.73508860448268132
0.76516284938412638
0.79523709428557143
0.82531133918701649
0.85538558408846155
0.88545982898990661
0.91553407389135166
0.94560831879279672
0.97568256369424178
1.00860632207201473
1.04153008044978757
1.07445383882756040
1.10737759720533324
1.14030135558310608
1.17322511396087892
1.20614887233865176
1.23907263071642459
1.27199638909419743
1.30492014747197027
1.33784390584974311
1.37174386402012982
1.40564382219051653
1.43954378036090325
1.47344373853128996
1.50734369670167667
1.54124365487206338
1.57514361304245010
1.60904357121283681
1.64294352938322352
1.67684348755361023
1.71074344572399695
1.74366720410176979
1.77659096247954262
1.80951472085731546
1.84243847923508830
1.87536223761286114
1.90828599599063398
1.94120975436840681
1.97413351274617965
2.00705727112395271
2.03998102950172555
2.07290478787949839
2.10297903278094367
2.13305327768238895
2.16312752258383423
2.19320176748527951
2.22327601238672479
2.25335025728817007
2.28342450218961535
2.31349874709106063
2.34357299199250591
2.37364723689395118
2.40372148179539646
2.42930375017194278
2.45488601854848909
2.48046828692503540
2.50605055530158172
2.53163282367812803
2.55721509205467434
2.58279736043122066
2.60837962880776697
2.63396189718431328
2.65954416556085960
2.68512643393740591
2.70493817596371677
2.72474991799002764
2.74456166001633850
2.76437340204264936
2.78418514406896023
2.80399688609527109
2.82380862812158195
2.84362037014789282
2.86343211217420368
2.88324385420051454
2.90305559622682541
2.91628575580381799
2.92951591538081058
2.94274607495780316
2.95597623453479574
2.96920639411178833
2.98243655368878091
2.99566671326577350
3.00889687284276608
3.02212703241975866
3.03535719199675125
3.04858735157374383
]';

X = log(exp(Y)-1); 

I_base = [0.13173777623847896
0.33947653580906240
0.62664940518897905
0.99205607100591009
1.42706634558606327
1.91348088763436830
2.42327056767551818
2.92088732166856824
3.36789633801334976
3.72885014666796533
3.97698535404797671
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.01174765221885618
0.02354080696282021
0.03537953185785948
0.04726389394078587
0.05919395965723215
0.07116979485967381
0.08319146480550173
0.09525903415513952
0.10737256697021025
0.11953212671175160
0.13173777623847896
0.15010166779690970
0.16856925755056146
0.18714074894834168
0.20581634237051563
0.22459623511791868
0.24348062140172450
0.26246969233376694
0.28156363591742201
0.30076263703904499
0.32006687745996937
0.33947653580906240
0.36469583774447645
0.39009157307739012
0.41566410311445251
0.44141378037889212
0.46734094859529790
0.49344594267698472
0.51972908871593271
0.54619070397529146
0.57283109688444256
0.59965056703660691
0.62664940518897871
0.65861871148023021
0.69083673790982170
0.72330391006822281
0.75602063672642161
0.78898730986644605
0.82220430471822792
0.85567197980273701
0.88939067698130236
0.92336072151103887
0.95758242210627509
0.99205607100590976
1.03008528672876842
1.06841712619218754
1.10705190556386701
1.14598991784170035
1.18523143300568568
1.22477669817883639
1.26462593779685872
1.30477935378636278
1.34523712575136623
1.38599941116784287
1.42706634558606260
1.46966937980707812
1.51259561775825691
1.55584513598594287
1.59941798739960217
1.64331420154711338
1.68753378489743322
1.73207672113030875
1.77694297143267810
1.82213247480146068
1.86764514835235818
1.91348088763436674
1.95830584444674605
2.00343527605825056
2.04886903009644561
2.09460693614781812
2.14064880604954810
2.18699443418443495
2.23364359777865795
2.28059605720215508
2.32785155627134177
2.37540982255391953
2.42327056767551641
2.46725310547487986
2.51148753312216177
2.55597359725364015
2.60071103423226013
2.64569957034610059
2.69093892200710805
2.73642879594999311
2.78216888943116292
2.82815889042758295
2.87439847783544877
2.92088732166857001
2.96062839606306527
3.00054937007576594
3.04065002605478218
3.08093014207988558
3.12138949204969895
3.16202784576852025
3.20284496903284310
3.24384062371747905
3.28501456786128099
3.32636655575244600
3.36789633801335242
3.40018035429468535
3.43257073142905877
3.46506734924643434
3.49767008636505761
3.53037882021446503
3.56319342705833231
3.59611378201723797
3.62913975909124042
3.66227123118238529
3.69550807011701421
3.72885014666797021
3.75117431983239635
3.77354532645719853
3.79596312730165808
3.81842768293005941
3.84093895371456284
3.86349689983804589
3.88610148129695077
3.90875265790410742
3.93145038929152602
3.95419463491322531
3.97698535404797981
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');