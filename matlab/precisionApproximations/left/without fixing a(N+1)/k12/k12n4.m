%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.01708452577902084
0.03416905155804167
0.05125357733706251
0.06833810311608335
0.08542262889510419
0.10250715467412502
0.11959168045314586
0.13667620623216670
0.15376073201118753
0.17084525779020837
0.18792978356922921
0.21461084402001832
0.24129190447080742
0.26797296492159650
0.29465402537238561
0.32133508582317472
0.34801614627396382
0.37469720672475293
0.40137826717554204
0.42805932762633114
0.45474038807712025
0.48142144852790936
0.51592567572056169
0.55042990291321403
0.58493413010586637
0.61943835729851870
0.65394258449117104
0.68844681168382338
0.72295103887647572
0.75745526606912805
0.79195949326178039
0.82646372045443273
0.86096794764708506
0.90057838428498249
0.94018882092287992
0.97979925756077735
1.01940969419867478
1.05902013083657232
1.09863056747446985
1.13824100411236739
1.17785144075026493
1.21746187738816247
1.25707231402606001
1.29668275066395755
1.33806655523175988
1.37945035979956221
1.42083416436736454
1.46221796893516687
1.50360177350296920
1.54498557807077153
1.58636938263857386
1.62775318720637618
1.66913699177417851
1.71052079634198084
1.75190460090978317
1.79151503754768071
1.83112547418557825
1.87073591082347579
1.91034634746137333
1.94995678409927087
1.98956722073716841
2.02917765737506572
2.06878809401296326
2.10839853065086080
2.14800896728875834
2.18761940392665588
2.22212363111930822
2.25662785831196055
2.29113208550461289
2.32563631269726523
2.36014053988991757
2.39464476708256990
2.42914899427522224
2.46365322146787458
2.49815744866052691
2.53266167585317925
2.56716590304583159
2.59384696349662081
2.62052802394741002
2.64720908439819924
2.67389014484898846
2.70057120529977768
2.72725226575056690
2.75393332620135611
2.78061438665214533
2.80729544710293455
2.83397650755372377
2.86065756800451299
2.87774209378353385
2.89482661956255471
2.91191114534157558
2.92899567112059644
2.94608019689961731
2.96316472267863817
2.98024924845765904
2.99733377423667990
3.01441830001570077
3.03150282579472163
3.04858735157374250
]';

X = log(exp(Y)-1); 

I_base = [0.17116384907609436
0.45723486691622223
0.86191184164032808
1.37577227440925665
1.96956849962566394
2.59238791063746232
3.17788337223004547
3.65762497177598389
3.97698535404797671
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.01517867302973966
0.03043325614073360
0.04576389440076975
0.06117073123610026
0.07665390842429869
0.09221356608733451
0.10784984268487291
0.12356287500779461
0.13935279817193935
0.15521974561207538
0.17116384907609436
0.19621854676283343
0.22146222679536176
0.24689536610684554
0.27251843144078874
0.29833187931065097
0.32433615596279691
0.35053169734278006
0.37691892906496793
0.40349826638550468
0.43027011417861089
0.45723486691622256
0.49239263166059744
0.52787445539989664
0.56368111365538920
0.59981335271277247
0.63627188961693926
0.67305741218191395
0.71017057901582747
0.74761201956078216
0.78538233414743341
0.82348209406411821
0.86191184164032786
0.90643624363895015
0.95139693436946449
0.99679459428222539
1.04262985443007028
1.08890329678040221
1.13561545455644319
1.18276681260690530
1.23035780780325643
1.27838882946377219
1.32686021980349755
1.37577227440925665
1.42734510114940916
1.47939943592129186
1.53193545638906969
1.58495328726297036
1.63845300103182212
1.69243461872059253
1.74689811067161305
1.80184339734809940
1.85727035015863207
1.91317879230123156
1.96956849962566283
2.02399233308931059
2.07885654531567532
2.13416082236126137
2.18990481350165833
2.24608813198036650
2.30271035576559280
2.35977102831414243
2.41726965934142068
2.47520572559663998
2.53357867164235806
2.59238791063746055
2.64397108200986386
2.69588441629183384
2.74812747009690561
2.80069978365362138
2.85360088120074451
2.90683027138203887
2.96038744764025630
3.01427188861011119
3.06848305850995073
3.12302040753186905
3.17788337223004325
3.22053009935022949
3.26337091036384974
3.30640552883369621
3.34963367393253764
3.39305506054751715
3.43666939938393545
3.48047639706834699
3.52447575625099674
3.56866717570747571
3.61305035043968692
3.65762497177598567
3.68626757340720745
3.71498846032121044
3.74378754921424850
3.77266475621928477
3.80161999691639352
3.83065318634312257
3.85976423900475973
3.88895306888457126
3.91821958945393956
3.94756371368246217
3.97698535404797715
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');