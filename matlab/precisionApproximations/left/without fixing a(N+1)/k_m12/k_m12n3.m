%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = -1/2;

N = 3;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.02378563153078546
0.04757126306157091
0.07135689459235636
0.09514252612314182
0.11892815765392728
0.14271378918471272
0.16649942071549817
0.19028505224628361
0.21407068377706906
0.23785631530785450
0.26164194683863995
0.30053671654910541
0.33943148625957087
0.37832625597003633
0.41722102568050179
0.45611579539096725
0.49501056510143271
0.53390533481189817
0.57280010452236363
0.61169487423282909
0.65058964394329455
0.68948441365376001
0.73883503140239015
0.78818564915102030
0.83753626689965044
0.88688688464828058
0.93623750239691073
0.98558812014554087
1.03493873789417101
1.08428935564280104
1.13363997339143108
1.18299059114006111
1.23234120888869114
1.28542347559745096
1.33850574230621078
1.39158800901497059
1.44467027572373041
1.49775254243249023
1.55083480914125005
1.60391707585000987
1.65699934255876968
1.71008160926752950
1.76316387597628932
1.81624614268504914
1.86559676043367917
1.91494737818230920
1.96429799593093923
2.01364861367956927
2.06299923142819930
2.11234984917682933
2.16170046692545936
2.21105108467408940
2.26040170242271943
2.30975232017134946
2.35910293791997949
2.39799770763044506
2.43689247734091063
2.47578724705137621
2.51468201676184178
2.55357678647230735
2.59247155618277292
2.63136632589323849
2.67026109560370406
2.70915586531416963
2.74805063502463520
2.78694540473510077
2.81073103626588638
2.83451666779667200
2.85830229932745761
2.88208793085824322
2.90587356238902883
2.92965919391981444
2.95344482545060005
2.97723045698138566
3.00101608851217128
3.02480172004295689
3.04858735157374250
]';

X = log(exp(Y)-1); 

I_base = [0.43975175346747142
1.06721618768196835
1.73175969446668820
2.32197471651546561
2.78467043876600728
3.10493776323486959
3.28521678288771213
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.04195212997187971
0.08349414054219612
0.12463121708113956
0.16536848124713446
0.20571099170827736
0.24566374485581885
0.28523167550980372
0.32441965761695912
0.36323250494094528
0.40167497174505556
0.43975175346747142
0.50123989901412647
0.56178254633847069
0.62139923838203903
0.68010912206636709
0.73793095564198519
0.79488311590879257
0.85098360531046613
0.90625005890546484
0.96069975121713380
1.01434960296533139
1.06721618768196835
1.13319259278767337
1.19796649728865390
1.26156944143667227
1.32403213978857170
1.38538450093435705
1.44565564680113168
1.50487393154291271
1.56306696002594991
1.62026160591886748
1.67648402939658903
1.73175969446668820
1.79018653216000256
1.84757667256245961
1.90395924009719497
1.95936251844456577
2.01381397285041519
2.06734027192287373
2.11996730892877361
2.17172022260044661
2.22262341746311032
2.27270058369295924
2.32197471651546472
2.36708413297808029
2.41153617581214919
2.45534779139828441
2.49853545976931146
2.54111520663052204
2.58310261511543926
2.62451283728178453
2.66536060535232622
2.70566024270502181
2.74542567461690190
2.78467043876600417
2.81524221556349241
2.84550504220403111
2.87546506137043911
2.90512827995557066
2.93450057194216640
2.96358768122993688
2.99239522441059114
3.02092869349159932
3.04919345856930635
3.07719477045217715
3.10493776323486825
3.12177852794848620
3.13852569370731738
3.15518037248712391
3.17174366105538308
3.18821664117507542
3.20460037980608226
3.22089592930419544
3.23710432761776579
3.25322659848203433
3.26926375161111604
3.28521678288771257
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');