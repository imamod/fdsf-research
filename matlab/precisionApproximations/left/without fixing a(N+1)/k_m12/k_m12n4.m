%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = -1/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.01708452577902084
0.03416905155804167
0.05125357733706251
0.06833810311608335
0.08542262889510419
0.10250715467412502
0.11959168045314586
0.13667620623216670
0.15376073201118753
0.17084525779020837
0.18792978356922921
0.21461084402001832
0.24129190447080742
0.26797296492159650
0.29465402537238561
0.32133508582317472
0.34801614627396382
0.37469720672475293
0.40137826717554204
0.42805932762633114
0.45474038807712025
0.48142144852790936
0.51592567572056169
0.55042990291321403
0.58493413010586637
0.61943835729851870
0.65394258449117104
0.68844681168382338
0.72295103887647572
0.75745526606912805
0.79195949326178039
0.82646372045443273
0.86096794764708506
0.90057838428498249
0.94018882092287992
0.97979925756077735
1.01940969419867478
1.05902013083657232
1.09863056747446985
1.13824100411236739
1.17785144075026493
1.21746187738816247
1.25707231402606001
1.29668275066395755
1.33806655523175988
1.37945035979956221
1.42083416436736454
1.46221796893516687
1.50360177350296920
1.54498557807077153
1.58636938263857386
1.62775318720637618
1.66913699177417851
1.71052079634198084
1.75190460090978317
1.79151503754768071
1.83112547418557825
1.87073591082347579
1.91034634746137333
1.94995678409927087
1.98956722073716841
2.02917765737506572
2.06878809401296326
2.10839853065086080
2.14800896728875834
2.18761940392665588
2.22212363111930822
2.25662785831196055
2.29113208550461289
2.32563631269726523
2.36014053988991757
2.39464476708256990
2.42914899427522224
2.46365322146787458
2.49815744866052691
2.53266167585317925
2.56716590304583159
2.59384696349662081
2.62052802394741002
2.64720908439819924
2.67389014484898846
2.70057120529977768
2.72725226575056690
2.75393332620135611
2.78061438665214533
2.80729544710293455
2.83397650755372377
2.86065756800451299
2.87774209378353385
2.89482661956255471
2.91191114534157558
2.92899567112059644
2.94608019689961731
2.96316472267863817
2.98024924845765904
2.99733377423667990
3.01441830001570077
3.03150282579472163
3.04858735157374250
]';

X = log(exp(Y)-1); 

I_base = [0.32055605031615525
0.77508279037245720
1.29136705688361175
1.80244517985878017
2.26214658744211317
2.64603528972199342
2.94469519573286131
3.15682453899573900
3.28521678288771213
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.03017471323031011
0.06013708220146317
0.08988903847343080
0.11943249653929801
0.14876935396427005
0.17790149152356971
0.20683077333924660
0.23555904701589964
0.26408814377532586
0.29241987859011020
0.32055605031615525
0.36410960706068618
0.40719725533163764
0.44982561563483142
0.49200121654911239
0.53373049589703836
0.57501980190134783
0.61587539432741290
0.65630344561186926
0.69631004197763724
0.73590118453549913
0.77508279037245753
0.82515507871187088
0.87456462499817522
0.92332361913111360
0.97144402950177489
1.01893760666737831
1.06581588696984264
1.11209019609910675
1.15777165260216597
1.20287117133877630
1.24739946688473102
1.29136705688361131
1.34116335556983590
1.39024962313413036
1.43864084560658223
1.48635169100705045
1.53339651550502598
1.57978936947355719
1.62554400343917727
1.67067387392971534
1.71519214922182694
1.75911171498999885
1.80244517985878017
1.84710601667664398
1.89115432135310435
1.93460354229003473
1.97746682368566495
2.01975701186153200
2.06148666147597348
2.10266804162607324
2.14331314183994470
2.18343367796113119
2.22304109792689930
2.26214658744211272
2.29911630324538008
2.33564556592610817
2.37174353673803884
2.40741917466805377
2.44268124060252756
2.47753830142043752
2.51199873401439788
2.54607072924056510
2.57976229579852179
2.61308126404207419
2.64603528972199165
2.67444962307278855
2.70259756498185899
2.73048386460132697
2.75811317827898161
2.78549007128199388
2.81261901949316062
2.83950441108002849
2.86615054813721049
2.89256164830223383
2.91874184634524036
2.94469519573286087
2.96461111688835510
2.98439557772976904
3.00405035587427882
3.02357720178075295
3.04297783915148434
3.06225396532879079
3.08140725168644947
3.10043934401612020
3.11935186290868938
3.13814640413068080
3.15682453899573900
3.16872418178159121
3.18057713217683480
3.19238378732212524
3.20414454044653185
3.21585978090540836
3.22752989421793179
3.23915526210432247
3.25073626252277181
3.26227326970599796
3.27376665419753943
3.28521678288771257
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');