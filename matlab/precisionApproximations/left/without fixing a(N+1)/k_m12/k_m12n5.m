%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = -1/2;

N = 5;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку
baseSize = 2*N+1;
j = 1:baseSize;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
x0 = log(exp(y0)-1);

Y = [0.01323015957699280
0.02646031915398560
0.03969047873097840
0.05292063830797120
0.06615079788496400
0.07938095746195681
0.09261111703894961
0.10584127661594242
0.11907143619293523
0.13230159576992803
0.14553175534692084
0.16534349737323148
0.18515523939954212
0.20496698142585276
0.22477872345216340
0.24459046547847405
0.26440220750478471
0.28421394953109536
0.30402569155740600
0.32383743358371664
0.34364917561002728
0.36346091763633792
0.38904318601288412
0.41462545438943033
0.44020772276597653
0.46578999114252273
0.49137225951906893
0.51695452789561513
0.54253679627216134
0.56811906464870754
0.59370133302525374
0.61928360140179994
0.64486586977834615
0.67494011467979120
0.70501435958123626
0.73508860448268132
0.76516284938412638
0.79523709428557143
0.82531133918701649
0.85538558408846155
0.88545982898990661
0.91553407389135166
0.94560831879279672
0.97568256369424178
1.00860632207201473
1.04153008044978757
1.07445383882756040
1.10737759720533324
1.14030135558310608
1.17322511396087892
1.20614887233865176
1.23907263071642459
1.27199638909419743
1.30492014747197027
1.33784390584974311
1.37174386402012982
1.40564382219051653
1.43954378036090325
1.47344373853128996
1.50734369670167667
1.54124365487206338
1.57514361304245010
1.60904357121283681
1.64294352938322352
1.67684348755361023
1.71074344572399695
1.74366720410176979
1.77659096247954262
1.80951472085731546
1.84243847923508830
1.87536223761286114
1.90828599599063398
1.94120975436840681
1.97413351274617965
2.00705727112395271
2.03998102950172555
2.07290478787949839
2.10297903278094367
2.13305327768238895
2.16312752258383423
2.19320176748527951
2.22327601238672479
2.25335025728817007
2.28342450218961535
2.31349874709106063
2.34357299199250591
2.37364723689395118
2.40372148179539646
2.42930375017194278
2.45488601854848909
2.48046828692503540
2.50605055530158172
2.53163282367812803
2.55721509205467434
2.58279736043122066
2.60837962880776697
2.63396189718431328
2.65954416556085960
2.68512643393740591
2.70493817596371677
2.72474991799002764
2.74456166001633850
2.76437340204264936
2.78418514406896023
2.80399688609527109
2.82380862812158195
2.84362037014789282
2.86343211217420368
2.88324385420051454
2.90305559622682541
2.91628575580381799
2.92951591538081058
2.94274607495780316
2.95597623453479574
2.96920639411178833
2.98243655368878091
2.99566671326577350
3.00889687284276608
3.02212703241975866
3.03535719199675125
3.04858735157374383
]';

X = log(exp(Y)-1); 

I_base = [0.25037149417311227
0.59872220202666593
1.00650400895818692
1.43364349875289721
1.84686738758064384
2.22325282276801062
2.54958985646067227
2.81971494694062663
3.03176274558163206
3.18626971087359445
3.28521678288771213
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.02338574464266043
0.04664388688454349
0.06977532642381472
0.09278095679831869
0.11566166542446595
0.13841833363587708
0.16105183672179324
0.18356304396524753
0.20595281868100210
0.22822201825325475
0.25037149417311227
0.28331759390946715
0.31599993418354561
0.34842130124255632
0.38058445262474477
0.41249211743098940
0.44414699659393636
0.47555176314468706
0.50670906247707725
0.53762151260957758
0.56829170444479038
0.59872220202666593
0.63766565997049207
0.67621908486215099
0.71438780260443435
0.75217706762418579
0.78959206374921209
0.82663790507510937
0.86331963682215718
0.89964223618240302
0.93561061315707084
0.97122961138441921
1.00650400895818670
1.04753791982856770
1.08810964486774586
1.12822660854899692
1.16789611675546467
1.20712535850750724
1.24592140766719295
1.28429122462029932
1.32224165793613113
1.35977944600549305
1.39691121865711931
1.43364349875289698
1.47340566107362814
1.51270500759511450
1.55154966890069423
1.58994763120904414
1.62790673871537228
1.66543469589917570
1.70253906979905500
1.73922729225508133
1.77550666211917840
1.81138434743398280
1.84686738758064273
1.88299743409865505
1.91872382229375149
1.95405382297090657
1.98899457177263606
2.02355307148983865
2.05773619433857924
2.09155068420337464
2.12500315884734547
2.15810011208977004
2.19084791595139494
2.22325282276800928
2.25440217086575601
2.28523938857148590
2.31576989034194858
2.34599899129609391
2.37593190891116768
2.40557376469412532
2.43492958582864150
2.46400430679803861
2.49280277098440850
2.52132973224421919
2.54958985646067093
2.57517479277962646
2.60054433252935224
2.62570184588249855
2.65065064575419385
2.67539398872099587
2.69993507592723470
2.72427705397886699
2.74842301582501314
2.77237600162728581
2.79613899961703316
2.81971494694062796
2.83962445338505631
2.85940245150964367
2.87905066451293035
2.89857079043178967
2.91796450249401218
2.93723344946661102
2.95637925599991691
2.97540352296748267
2.99430782780183291
3.01309372482610804
3.03176274558163250
3.04614129872423955
3.06045135309789496
3.07469359260269082
3.08886869335082714
3.10297732375295832
3.11702014460368426
3.13099780916623160
3.14491096325629682
3.15876024532507849
3.17254628654149373
3.18626971087359667
3.19539956552350235
3.20450195343356636
3.21357705516087044
3.22262504988334531
3.23164611541012103
3.24064042819185083
3.24960816333093527
3.25854949459169507
3.26746459441047898
3.27635363390567935
3.28521678288771390
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N+1)
            A(i,j) = y0(i)^j;
        elseif (j >= N+2 && j <=baseSize)
            A(i,j) = -z(i)*y0(i)^(j-N-1);
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N+1)
        a(j) = E(j);
    elseif (j >= N+2 && j <=baseSize)
        b(j-N-1) = E(j);
    end
end
% a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');