%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.01992070521711391
0.03984141043422781
0.05976211565134172
0.07968282086845563
0.09960352608556954
0.11952423130268344
0.13944493651979734
0.15936564173691126
0.17928634695402518
0.19920705217113910
0.21912775738825302
0.25095745333880926
0.28278714928936549
0.31461684523992173
0.34644654119047796
0.37827623714103420
0.41010593309159044
0.44193562904214667
0.47376532499270291
0.50559502094325914
0.53742471689381544
0.56925441284437173
0.61019885569468346
0.65114329854499520
0.69208774139530693
0.73303218424561867
0.77397662709593040
0.81492106994624214
0.85586551279655387
0.89680995564686561
0.93775439849717734
0.97869884134748908
1.01964328419780093
1.06552059252408005
1.11139790085035917
1.15727520917663829
1.20315251750291741
1.24902982582919653
1.29490713415547565
1.34078444248175477
1.38666175080803389
1.43253905913431301
1.47841636746059213
1.52429367578687125
1.57017098411315037
1.61604829243942949
1.66192560076570861
1.70780290909198773
1.75368021741826685
1.79955752574454597
1.84543483407082509
1.89131214239710421
1.93718945072338333
1.98306675904966245
2.02894406737594135
2.06988851022625298
2.11083295307656460
2.15177739592687622
2.19272183877718785
2.23366628162749947
2.27461072447781110
2.31555516732812272
2.35649961017843435
2.39744405302874597
2.43838849587905759
2.47933293872936922
2.51116263467992562
2.54299233063048202
2.57482202658103843
2.60665172253159483
2.63848141848215123
2.67031111443270763
2.70214081038326404
2.73397050633382044
2.76580020228437684
2.79762989823493324
2.82945959418548965
2.84938029940260362
2.86930100461971760
2.88922170983683158
2.90914241505394555
2.92906312027105953
2.94898382548817350
2.96890453070528748
2.98882523592240146
3.00874594113951543
3.02866664635662941
3.04858735157374339
]';

X = log(exp(Y)-1); 

I_base = [0.20047882011444870
0.54736921874898470
1.04290145244519938
1.66538357256125846
2.35943324683454847
3.03886654060988315
3.60552312495264227
3.97698535404797671
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.01770580732463749
0.03551485302032474
0.05342736641233936
0.07144357378726159
0.08956369837777439
0.10778796034801738
0.12611657677950150
0.14454976165758274
0.16308772585850217
0.18173067713699176
0.20047882011444870
0.23065379063716160
0.26109863698192443
0.29181414362578945
0.32280107428352800
0.35406017182335719
0.38559215819229009
0.41739773435111077
0.44947758021896966
0.48183235462758361
0.51446269528501265
0.54736921874898503
0.59010594402568251
0.63330187406962468
0.67695816671623943
0.72107592188683212
0.76565618168277438
0.81069993052074396
0.85620809530839559
0.90218154565981690
0.94862109415000917
0.99552749660763573
1.04290145244519938
1.09653911615750022
1.15076540686675455
1.20558105971706397
1.26098672376069820
1.31698296286367000
1.37357025667286559
1.43074900164221042
1.48851951211532874
1.54688202146205001
1.60583668326609796
1.66538357256125868
1.72552268711324963
1.78625394874454746
1.84757720469936149
1.90949222904596771
1.97199872411359722
2.03509632196108781
2.09878458587451711
2.16306301189105454
2.22793103034630802
2.29338800744246596
2.35943324683454936
2.41887327436991439
2.47878068107513139
2.53915485192459167
2.59999513609505684
2.66130084789290944
2.72307126768339325
2.78530564282090021
2.84800318857923607
2.91116308908093613
2.97478449822467139
3.03886654060988048
3.08900077173678156
3.13941239618645573
3.19010096808554078
3.24106603204772403
3.29230712342986775
3.34382376858658770
3.39561548512313527
3.44768178214651178
3.50002216051465087
3.55263611308360838
3.60552312495264271
3.63876130355271821
3.67210610322624431
3.70555739335645518
3.73911504225641789
3.77277891719163527
3.80654888440252126
3.84042480912671591
3.87440655562122149
3.90849398718441199
3.94268696617785874
3.97698535404797937
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');