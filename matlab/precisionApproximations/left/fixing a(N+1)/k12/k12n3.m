%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 3;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.02931106723398783
0.05862213446797566
0.08793320170196349
0.11724426893595132
0.14655533616993915
0.17586640340392698
0.20517747063791480
0.23448853787190263
0.26379960510589046
0.29311067233987831
0.32242173957386616
0.37138048576234062
0.42033923195081513
0.46929797813928964
0.51825672432776415
0.56721547051623866
0.61617421670471317
0.66513296289318768
0.71409170908166220
0.76305045527013671
0.81200920145861122
0.86096794764708573
0.92127028656888443
0.98157262549068314
1.04187496441248184
1.10217730333428054
1.16247964225607925
1.22278198117787795
1.28308432009967666
1.34338665902147536
1.40368899794327406
1.46399133686507277
1.52429367578687147
1.58459601470867018
1.64489835363046888
1.70520069255226758
1.76550303147406629
1.82580537039586499
1.88610770931766369
1.94641004823946240
2.00671238716126110
2.06701472608305981
2.12731706500485851
2.18761940392665721
2.23657815011513161
2.28553689630360601
2.33449564249208041
2.38345438868055481
2.43241313486902921
2.48137188105750361
2.53033062724597801
2.57928937343445241
2.62824811962292681
2.67720686581140122
2.72616561199987562
2.75547667923386363
2.78478774646785165
2.81409881370183967
2.84340988093582769
2.87272094816981571
2.90203201540380373
2.93134308263779175
2.96065414987177977
2.98996521710576779
3.01927628433975581
3.04858735157374383
]';

X = log(exp(Y)-1); 

I_base = [0.29938723861304550
0.86191184164032808
1.66538357256125846
2.59238791063746232
3.43488932951477199
3.97698535404797671
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.02608788381693098
0.05239951083713304
0.07893560473513105
0.10569687487592397
0.13268401621467543
0.15989770920208221
0.18733861969546661
0.21500739887562720
0.24290468316947769
0.27103109417850191
0.29938723861304550
0.34726490639299401
0.39578782919816213
0.44495855384745697
0.49477950930398168
0.54525300632936591
0.59638123726452064
0.64816627593588816
0.70061007768598005
0.75371447952672521
0.80748120041385685
0.86191184164032864
0.92986856797761130
0.99883728724077459
1.06882026382362416
1.13981949856913278
1.21183673163009753
1.28487344567771578
1.35893086944245689
1.43400998157081894
1.51011151478094008
1.58723596029941572
1.66538357256125868
1.74455437415452952
1.82474816099094705
1.90596450768357051
1.98820277311259974
2.07146210616032089
2.15574145159636643
2.24103955609457106
2.32735497436303707
2.41468607536927804
2.50303104864273873
2.59238791063746277
2.66567846827161148
2.73963338160456704
2.81425135458499964
2.88953102608679835
2.96547097217907663
3.04206970838940505
3.11932569195717102
3.19723732407412120
3.27580295210924843
3.35502087181535646
3.43488932951477155
3.48301627987894902
3.53137536276304598
3.57996617825781716
3.62878832098043214
3.67784138023446561
3.72712494016846652
3.77663857993302754
3.82638187383635930
3.87635439149828942
3.92655569800264104
3.97698535404797981
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
% B = z(1,:) - (gamma(k+1))*y0.*ones(1,2*N);
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');