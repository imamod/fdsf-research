%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 5/2;

N = 3;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.02931106723398783
0.05862213446797566
0.08793320170196349
0.11724426893595132
0.14655533616993915
0.17586640340392698
0.20517747063791480
0.23448853787190263
0.26379960510589046
0.29311067233987831
0.32242173957386616
0.37138048576234062
0.42033923195081513
0.46929797813928964
0.51825672432776415
0.56721547051623866
0.61617421670471317
0.66513296289318768
0.71409170908166220
0.76305045527013671
0.81200920145861122
0.86096794764708573
0.92127028656888443
0.98157262549068314
1.04187496441248184
1.10217730333428054
1.16247964225607925
1.22278198117787795
1.28308432009967666
1.34338665902147536
1.40368899794327406
1.46399133686507277
1.52429367578687147
1.58459601470867018
1.64489835363046888
1.70520069255226758
1.76550303147406629
1.82580537039586499
1.88610770931766369
1.94641004823946240
2.00671238716126110
2.06701472608305981
2.12731706500485851
2.18761940392665721
2.23657815011513161
2.28553689630360601
2.33449564249208041
2.38345438868055481
2.43241313486902921
2.48137188105750361
2.53033062724597801
2.57928937343445241
2.62824811962292681
2.67720686581140122
2.72616561199987562
2.75547667923386363
2.78478774646785165
2.81409881370183967
2.84340988093582769
2.87272094816981571
2.90203201540380373
2.93134308263779175
2.96065414987177977
2.98996521710576779
3.01927628433975581
3.04858735157374383
]';

X = log(exp(Y)-1); 

I_base = [1.22535268810270570
4.11427079216712510
9.69695941664353889
18.50182566303507770
28.92104549233417998
36.93206541329328019
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.09859458122531432
0.19959018479729365
0.30303813331465534
0.40899061098397427
0.51750067131010447
0.62862224468787431
0.74241014589143428
0.85892008145767407
0.97820865696021020
1.10033338417049698
1.22535268810270570
1.44079208114907331
1.66475550773742964
1.89753260566567516
2.13942039747404333
2.39072337089571407
2.65175355626591092
2.92283060079861734
3.20428183964667390
3.49644236366781769
3.79965508382632589
4.11427079216712688
4.51798592272918054
4.94023200743389967
5.38171457603458947
5.84315782326808808
6.32530472519525144
6.82891714278341411
7.35477591271552100
7.90368092545054512
8.47645119059892771
9.07392488971477995
9.69695941664354244
10.34643140559922969
11.02323674717902158
11.72829059255541218
12.46252734611598179
13.22690064684915612
14.02238333880040067
14.84996743094706950
15.71066404686178686
16.60550336455337472
17.53553454689140167
18.50182566303507770
19.31376462713970099
20.15091160017521688
21.01386542973290972
21.90323302479693268
22.81962931559828434
23.76367721159207491
24.73600755766480574
25.73725908867890766
26.76807838246098115
27.82911981133907631
28.92104549233417288
29.58982676393486244
30.27006281392626974
30.96189966536931593
31.66548431483943560
32.38096472825903049
33.10848983668993384
33.84820953208876659
34.60027466302769028
35.36483703038283011
36.14204938299339176
36.93206541329333703
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');