%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 5/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.01992070521711391
0.03984141043422781
0.05976211565134172
0.07968282086845563
0.09960352608556954
0.11952423130268344
0.13944493651979734
0.15936564173691126
0.17928634695402518
0.19920705217113910
0.21912775738825302
0.25095745333880926
0.28278714928936549
0.31461684523992173
0.34644654119047796
0.37827623714103420
0.41010593309159044
0.44193562904214667
0.47376532499270291
0.50559502094325914
0.53742471689381544
0.56925441284437173
0.61019885569468346
0.65114329854499520
0.69208774139530693
0.73303218424561867
0.77397662709593040
0.81492106994624214
0.85586551279655387
0.89680995564686561
0.93775439849717734
0.97869884134748908
1.01964328419780093
1.06552059252408005
1.11139790085035917
1.15727520917663829
1.20315251750291741
1.24902982582919653
1.29490713415547565
1.34078444248175477
1.38666175080803389
1.43253905913431301
1.47841636746059213
1.52429367578687125
1.57017098411315037
1.61604829243942949
1.66192560076570861
1.70780290909198773
1.75368021741826685
1.79955752574454597
1.84543483407082509
1.89131214239710421
1.93718945072338333
1.98306675904966245
2.02894406737594135
2.06988851022625298
2.11083295307656460
2.15177739592687622
2.19272183877718785
2.23366628162749947
2.27461072447781110
2.31555516732812272
2.35649961017843435
2.39744405302874597
2.43838849587905759
2.47933293872936922
2.51116263467992562
2.54299233063048202
2.57482202658103843
2.60665172253159483
2.63848141848215123
2.67031111443270763
2.70214081038326404
2.73397050633382044
2.76580020228437684
2.79762989823493324
2.82945959418548965
2.84938029940260362
2.86930100461971760
2.88922170983683158
2.90914241505394555
2.92906312027105953
2.94898382548817350
2.96890453070528748
2.98882523592240146
3.00874594113951543
3.02866664635662941
3.04858735157374339
]';

X = log(exp(Y)-1); 

I_base = [0.79751887652249676
2.40139796421478513
5.21666898021487135
9.69695941664353889
16.03653601609275015
23.72380126699324876
31.32914635292582872
36.93206541329328019
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.06674896264575345
0.13459942423968296
0.20356736670511877
0.27366895472905628
0.34492053688840357
0.41733864676684379
0.49094000406207311
0.56574151568316366
0.64176027683781467
0.71901357210924466
0.79751887652249676
0.92559869446388832
1.05699318193163361
1.19177669311044454
1.33002485839661300
1.47181459472825993
1.61722411571056268
1.76633294153051734
1.91922190865596609
2.07597317931383607
2.23667025074267034
2.40139796421478646
2.61936331177063009
2.84432778567063282
3.07648192805169973
3.31602006567565599
3.56314033678638253
3.81804471680348989
4.08093904283548348
4.35203303699712585
4.63154032851752273
4.91967847462726926
5.21666898021486958
5.56023514591696166
5.91552146877341567
6.28285737281830237
6.66257861390839068
7.05502730275873979
7.46055192550475876
7.87950736179902034
8.31225490045533277
8.75916225265687665
9.22060356274928949
9.69695941664354066
10.18861684785743194
10.69596934122797016
11.21941683433077586
11.75936571664582786
12.31622882651213580
12.89042544591699624
13.48238129316830225
14.09252851350110625
14.72130566767197912
15.36915771859724167
16.03653601609276080
16.64901819046443521
17.27774746460290700
17.92305750873911308
18.58528599834609096
19.26477460088596416
19.96186896177875525
20.67691868962366541
21.41027734070264188
22.16230240279720931
22.93335527834873133
23.72380126699322034
24.35191795778535706
24.99215259478147644
25.64468163518005284
26.30968293515326906
26.98733574420310788
27.67782069941527467
28.38131981961554473
29.09801649943447188
29.82809550328419235
30.57174295925363339
31.32914635292583583
31.81025208539062632
32.29686640443270562
32.78903607575860946
33.28680807018834997
33.79022956303622038
34.29934793348834887
34.81421076397712255
35.33486583955268401
35.86136114725164958
36.39374487546333370
36.93206541329331571
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');