%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 7/2;

N = 2;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.05175040116767015
0.10350080233534030
0.15525120350301044
0.20700160467068060
0.25875200583835073
0.31050240700602089
0.36225280817369104
0.41400320934136120
0.46575361050903136
0.51750401167670146
0.56925441284437162
0.65607616402096247
0.74289791519755333
0.82971966637414418
0.91654141755073504
1.00336316872732589
1.09018491990391664
1.17700667108050738
1.26382842225709813
1.35065017343368887
1.43747192461027962
1.52429367578687036
1.61111542696346133
1.69793717814005229
1.78475892931664326
1.87158068049323423
1.95840243166982519
2.04522418284641594
2.13204593402300668
2.21886768519959743
2.30568943637618817
2.39251118755277892
2.47933293872936966
2.53108333989703960
2.58283374106470953
2.63458414223237947
2.68633454340004940
2.73808494456771934
2.78983534573538927
2.84158574690305921
2.89333614807072914
2.94508654923839908
2.99683695040606901
3.04858735157373895
]';

X = log(exp(Y)-1); 

I_base = [8.64977894571952000
37.24367857481750121
98.86887281584330367
162.56644043989513193
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.61635640115681611
1.26239310273989780
1.93943958070435007
2.64887778712246869
3.39214377313842386
4.17072933748207131
4.98618369979104337
5.84011519794533651
6.73419300857541803
7.67014888986359189
8.64977894571952000
10.39656637201088962
12.28078056780530147
14.31221133417293423
16.50123568758289494
18.85884285736255706
21.39665957055546741
24.12697558118435381
27.06276940046202739
30.21773418437573255
33.60630373529592418
37.24367857481747990
41.14585204591879375
45.32963640369973035
49.81268885541479108
54.61353751222340236
59.75160721701057298
65.24724521475550887
71.12174663421161824
77.39737975207779641
84.09741101335394831
91.24612978415179043
98.86887281584318998
103.64873719032931376
108.61215084618832805
113.76503050042819609
119.11343466790164314
124.66356540337950776
130.42177002772302785
136.39454283796209211
142.58852680112642020
149.01051523170715996
155.66745345265977107
162.56644043989476245
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');