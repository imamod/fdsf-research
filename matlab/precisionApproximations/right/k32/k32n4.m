%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 3/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.01992070521711391
0.03984141043422781
0.05976211565134172
0.07968282086845563
0.09960352608556954
0.11952423130268344
0.13944493651979734
0.15936564173691126
0.17928634695402518
0.19920705217113910
0.21912775738825302
0.25095745333880926
0.28278714928936549
0.31461684523992173
0.34644654119047796
0.37827623714103420
0.41010593309159044
0.44193562904214667
0.47376532499270291
0.50559502094325914
0.53742471689381544
0.56925441284437173
0.61019885569468346
0.65114329854499520
0.69208774139530693
0.73303218424561867
0.77397662709593040
0.81492106994624214
0.85586551279655387
0.89680995564686561
0.93775439849717734
0.97869884134748908
1.01964328419780093
1.06552059252408005
1.11139790085035917
1.15727520917663829
1.20315251750291741
1.24902982582919653
1.29490713415547565
1.34078444248175477
1.38666175080803389
1.43253905913431301
1.47841636746059213
1.52429367578687125
1.57017098411315037
1.61604829243942949
1.66192560076570861
1.70780290909198773
1.75368021741826685
1.79955752574454597
1.84543483407082509
1.89131214239710421
1.93718945072338333
1.98306675904966245
2.02894406737594135
2.06988851022625298
2.11083295307656460
2.15177739592687622
2.19272183877718785
2.23366628162749947
2.27461072447781110
2.31555516732812272
2.35649961017843435
2.39744405302874597
2.43838849587905759
2.47933293872936922
2.51116263467992562
2.54299233063048202
2.57482202658103843
2.60665172253159483
2.63848141848215123
2.67031111443270763
2.70214081038326404
2.73397050633382044
2.76580020228437684
2.79762989823493324
2.82945959418548965
2.84938029940260362
2.86930100461971760
2.88922170983683158
2.90914241505394555
2.92906312027105953
2.94898382548817350
2.96890453070528748
2.98882523592240146
3.00874594113951543
3.02866664635662941
3.04858735157374339
]';

X = log(exp(Y)-1); 

I_base = [0.31269347409950421
0.90968755107532462
1.88290665517422351
3.30055373767231464
5.12886930653370587
7.16291360777494202
9.03827271958856748
10.35371486476145009
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.02665247601750197
0.05364938843942611
0.08099417097952029
0.10869027475540535
0.13674116813898141
0.16515033660405426
0.19392128257122701
0.22305752525009062
0.25256260047875867
0.28244006056078402
0.31269347409950421
0.36182216644129034
0.41193454308066968
0.46304541366417257
0.51516968820711673
0.56832237520609030
0.62251857971474156
0.67777350138423942
0.73410243246981022
0.79152075580478587
0.85004394274361106
0.90968755107532495
0.98808352687511680
1.06839287347716105
1.15064930274849297
1.23488673617907674
1.32113929704342747
1.40944130247725918
1.49982725547864493
1.59233183684324242
1.68698989704313451
1.78383644805886754
1.88290665517422284
1.99659782878631220
2.11317494321621124
2.23268807476998710
2.35518748623462360
2.48072361231611316
2.60934704512048476
2.74110851969724001
2.87605889966421691
3.01424916293234135
3.15573038754827584
3.30055373767231552
3.44877044970830671
3.60043181860168993
3.75558918432114774
3.91429391853852282
4.07659741152108079
4.24255105924933407
4.41220625077294404
4.58561435581640886
4.76282671264547908
4.94389461620446724
5.12886930653370854
5.29729589969766224
5.46891139621992650
5.64375206754445635
5.82185412416051751
6.00325370985303319
6.18798689611368324
6.37608967671482318
6.56759796244762306
6.76254757602579115
6.96097424715588708
7.16291360777493225
7.32234823469817897
7.48394381078235771
7.64771694319732553
7.81368419771521339
7.98186209756988063
8.15226712235323170
8.32491570694813809
8.49982424049790453
8.67700906541198869
8.85648647640786102
9.03827271958857104
9.15322603854357375
9.26909401357465690
9.38588059733101154
9.50358973458006595
9.62222536213258905
9.74179140876985628
9.86229179517291321
9.98373043385379333
10.10611122908881043
10.22943807685381934
10.35371486476145897
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');