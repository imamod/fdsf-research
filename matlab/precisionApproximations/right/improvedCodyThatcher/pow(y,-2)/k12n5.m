%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 5;
baseSize = 2*N;
a = zeros(1,N); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:baseSize;
f = fopen('n5/y_base_right','r');
y0 = fscanf(f, '%f');
y0 = y0';
fclose(f);
x0 = log(exp(y0)-1);

f = fopen('n5/y_add_right','r');
Y = fscanf(f, '%f');
Y = Y';
fclose(f); 
X = log(exp(Y)-1); 

f = fopen('n5/I_base_right','r');
I_base = fscanf(f, '%f');
I_base = I_base';
fclose(f); 

f = fopen('n5/I_add_right','r');
I_add = fscanf(f, '%f');
I_add = I_add';
fclose(f); 

y0 =[
15.00000030590227240
15.37069833161010379
15.89348556884357855
16.60972875220334899
17.57977970650866695
18.89881613383580827
20.73110302182113784
23.39790158227690853
27.66788107557722043
36.28947157990450023
]';

x0 = log(exp(y0)-1);

Y = [
15.00000030590227951
15.03295964391921302
15.06606414328966359
15.09931476512169723
15.13271247902676819
15.16625826321395998
15.19995310458549476
15.23379799883351815
15.26779395053817900
15.30194197326701655
15.33624308967570116
15.37069833161011978
15.41679901360105198
15.46317706311948825
15.50983499091609907
15.55677533813659785
15.60400067678308211
15.65151361018381060
15.69931677347159216
15.74741283407095693
15.79580449219432481
15.84449448134733807
15.89348556884357855
15.95603599656678284
16.01908071675893908
16.08262561173568983
16.14667665752087444
16.21123992572001882
16.27632158543893937
16.34192790524876315
16.40806525519864323
16.47474010887757956
16.54195904552667784
16.60972875220334899
16.69346915247297147
16.77805821056419688
16.86350889312475587
16.94983443231125975
17.03704833261996043
17.12516437792951152
17.21419663876336159
17.30415947977993341
17.39506756749885596
17.48693587827203189
17.57977970650867050
17.69203512087732477
17.80573335883612529
17.92090241731691691
18.03757102231370979
18.15576865276988272
18.27552556541075646
18.39687282056547701
18.51984230902450079
18.64446677998146740
18.77077987011087501
18.89881613383580117
19.05189546950088797
19.20747492380734656
19.36561624960058836
19.52638325033358413
19.68984186589674579
19.85606026279519654
20.02510892893248595
20.19706077327764859
20.37199123071167861
20.54997837237014480
20.73110302182113074
20.94815633696243040
21.16980281067431946
21.39618979879340799
21.62747102850363845
21.86380694645329115
22.10536508994865912
22.35232048302899699
22.60485605939047815
22.86316311430685033
23.12744178789294835
23.39790158227690497
23.73084497919745672
24.07340047293276797
24.42599041286912964
24.78906225986945344
25.16309048073800625
25.54857861681966824
25.94606154569788359
26.35610795735313872
26.77932306888805414
27.21635160507223006
27.66788107557723109
28.27864396650666734
28.91698047458119802
29.58480098880533760
30.28419654737376376
31.01746070775404007
31.78711467281843994
32.59593625297496544
33.44699336538435830
34.34368292171488690
35.28977614353185999
36.28947157990450023
39.91841873789495310
44.35379859766105426
49.89802342236868782
57.02631248270706976
66.53069789649158849
79.83683747578990619
99.79604684473737564
133.06139579298317699
199.59209368947475127
399.18418737894950254
]';

X = log(exp(Y)-1); 

% Проверка
y0 = x0;
Y = X;

I_base = [
38.94304660093270343
40.38495939215574992
42.44835695138822018
45.33113392790861695
49.33601715955190059
54.96191879495028587
63.10878043544731497
75.62288662080612767
97.17906945447104761
145.87693641250697851
]';

 C1 = (k+1)*k*(pi^2)/6;
 z = ((I_base*(k+1)./(y0.^(k+1)) - 1).*(y0.^2))/C1;

I_add = [
38.94304660093273185
39.07052991491847393
39.19871652220713543
39.32761185933220105
39.45722141697278573
39.58755074061424750
39.71860543121804454
39.85039114590188092
39.98291359862908223
40.11617856090847312
40.25019186250412417
40.38495939215580677
40.56551473209350434
40.74743096276371546
40.93072246949894577
41.11540383370919471
41.30148983615858072
41.48899546030634156
41.67793589571471102
41.86832654152433975
42.06018300999929238
42.25352113014321986
42.44835695138822018
42.69755747656115830
42.94922532831274964
43.20339480220593487
43.46010080909122308
43.71937888865200250
43.98126522330380794
44.24579665245787652
44.51301068716055198
44.78294552511965776
45.05564006612975447
45.33113392790861695
45.67233279030934057
46.01786474656792336
46.36780714599545661
46.72223912208542629
47.08124164307184856
47.44489756418921900
47.81329168170077537
48.18651078876452942
48.56464373320949335
48.94778147729770978
49.33601715955191480
49.80680252866262947
50.28517208344496936
50.77129781715214563
51.26535677016207160
51.76753121218049358
52.27800883226835538
52.79698293708423051
53.32465265775464758
53.86122316580780023
54.40690589863254445
54.96191879495025745
55.62797162522561223
56.30766256485000554
57.00138547076993234
57.70954894448916406
58.43257701235329904
59.17090984324185854
59.92500450606081586
60.69533576960435539
61.48239694754434481
62.28670079151041250
63.10878043544728655
64.09868933538658098
65.11487249466907201
66.15831603456805965
67.23005417431896547
68.33117212976237909
69.46280922072070041
70.62616220464656180
71.82248885576926511
73.05311181083882843
74.31942270464588773
75.62288662080611346
77.23788876808393411
78.91141712319276280
80.64648303908563776
82.44630004136794810
84.31430066861213390
86.25415499592614310
88.26979103893549450
90.36541726192916713
92.54554744457620075
94.81502819705474394
97.17906945447110445
100.40765607199583087
103.81953967084710655
107.42962167265527285
111.25439799707510247
115.31217266426563128
119.62330605789088622
124.21050450410689336
129.09915930838309350
134.31774525939664500
139.89829096857965851
145.87693641250697851
168.26935374074662377
197.05041730526346555
235.09801862550364149
287.20132864103186421
361.87860901762371668
475.66127059382512243
664.71051323990673154
1023.33331988743213969
1879.91057700533747266
5317.06656869555990852
]';

 I = ((I_add*(k+1)./(Y.^(k+1)) - 1).*(Y.^2))/C1;

% Задаем матрицы A и B
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j > 0 && j < N + 1)
            A(i,j) = y0(i)^(-2*j);
        elseif (j >= N+1 && j <= baseSize)
            A(i,j) = -z(i)*y0(i)^(-2*(j-N));
        end
    end
end
disp('A matrix: ')
disp(A); 
disp('B matrix: ')
disp(B');
E = A\B';
% disp(E);

for j = 1:length(E)
    if (j > 0 && j < N + 1)
        a(j) = E(j);
    elseif (j > N && j <= baseSize)
        b(j-N) = E(j);
    end
end
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a');
disp('----------------------------');
disp('Коэффициенты b:'); disp(b');
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*y0(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^(-2*m);
    end
    F_base(j) = (1 + S1)/(1 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*Y(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^(-2*m);
    end
    F(j) = (1 + S1)/(1 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));
disp('-------------------');
disp('Экстремумы Z:');
disp(max(abs(delta_additional(1:11))));
disp(max(abs(delta_additional(11:22))));
disp(max(abs(delta_additional(22:33))));
disp(max(abs(delta_additional(33:44))));
disp(max(abs(delta_additional(44:55))));
disp(max(abs(delta_additional(55:66))));
disp(max(abs(delta_additional(66:77))));
disp(max(abs(delta_additional(77:end))));
disp('-------------------');

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)

app_I_base = zeros(1,length(F_base));
delta_base_I = zeros(1,length(F_base));
for i=1:length(F_base)
    app_I_base(i) = (F_base(i)*(C1/(y0(i)^2)) + 1)*((y0(i)^(k + 1))/(k+1));
    delta_base_I(i) = app_I_base(i)/I_base(i)-1;
end

app_I = zeros(1,length(Y));
delta_additional_I = zeros(1,length(Y));
for i=1:length(app_I)
    app_I(i) = (F(i)*(C1/(Y(i)^2)) + 1)*((Y(i)^(k + 1))/(k+1));
    delta_additional_I(i) = app_I(i)/I_add(i)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional_I))));
disp('-------------------');
disp('Экстремумы I:');
span = 11;
max_delta = max(abs(delta_additional_I(1:span)));
disp(log10(max_delta));
for i=1:baseSize-1 
    max_delta = max(abs(delta_additional_I((i*span):(i+1)*span)));
    disp(log10(max_delta));
end
disp('-------------------');

figure
grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional_I, 'k','linewidth', 2.5);
plot(y0,delta_base_I, 'k*','linewidth',5)

