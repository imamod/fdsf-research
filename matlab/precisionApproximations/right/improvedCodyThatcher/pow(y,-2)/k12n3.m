%%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 3;
baseSize = 2*N;
% x_star = 3;
x_star = 7;
y_star = log(1+exp(x_star));

y_star_inv = 1/(y_star^2);

a = zeros(1,N); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:baseSize;
alpha = 2/(2+pi);
% y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
y0_inv = 0.5*y_star_inv*(2*alpha*j/baseSize + (1-alpha)*(1 - cos(pi*j/baseSize)));
y0 = 1./sqrt(y0_inv(end:-1:1));
x0 = log(exp(y0)-1);

Y = [3.04858735157374383
3.06334941986178944
3.07832803167305524
3.09352853341052692
3.10895645812305865
3.12461753396741315
3.14051769314397689
3.15666308133780493
3.17306006769913074
3.18971525540013978
3.20663549280775984
3.22382788531539566
3.25317180839742948
3.28333188319319724
3.31434665817738860
3.34625727996008715
3.37910772285540384
3.41294504373919549
3.44781966555554220
3.48378569335744803
3.52090126738820164
3.55922895844575837
3.59883621164772682
3.64948727062435641
3.70233898243140258
3.75755546062086943
3.81531848053134270
3.87583000074134842
3.93931513892254026
4.00602570215380638
4.07624439807403327
4.15028988769767260
4.22852288620647787
4.31135357867466062
4.39925069935656055
4.49275273436214651
4.59248186072577980
4.69916144857952034
4.81363825540862766
4.93691087531820916
5.07016663946711255
5.21483010445979112
5.37262769044987465
5.54567523674089635
5.73659874135033565
5.90700705919880509
6.09356344451193976
6.29899073808931664
6.52670118292486823
6.78103840914365907
7.06763204845108817
7.39393268303317797
7.77004660227837274
8.21009158875834899
8.73450756239548198
9.37423435716954323
9.83177993862005017
10.36360601986327445
10.99226414128657048
11.75122466331863080
12.69277332195054342
13.90423653146419092
15.54540902979491257
17.95029217602986549
21.98452828257314096
31.09081805958982514
]';

Y = [
0.04179444039572801
0.04643826710636445
0.05108209381700089
0.05356149404504866
0.05604089427309643
0.05852029450114420
0.06099969472919196
0.06347909495723973
0.06595849518528750
0.06843789541333527
0.07091729564138304
0.07339669586943080
0.07587609609747857
0.07835549632552634
0.08041427875252891
0.08247306117953147
0.08453184360653404
0.08659062603353661
0.08864940846053918
0.09070819088754174
0.09276697331454431
0.09482575574154688
0.09688453816854944
0.09894332059555201
0.10100210302255458
0.10267726778106434
0.10435243253957410
0.10602759729808386
0.10770276205659363
0.10937792681510339
0.11105309157361315
0.11272825633212291
0.11440342109063267
0.11607858584914243
0.11775375060765220
0.11942891536616196
0.12069830157310214
0.12196768778004233
0.12323707398698251
0.12450646019392270
0.12577584640086290
0.12704523260780309
0.12831461881474329
0.12958400502168349
0.13085339122862369
0.13212277743556389
0.13339216364250409
0.13425092548615838
0.13510968732981268
0.13596844917346698
0.13682721101712128
0.13768597286077558
0.13854473470442988
0.13940349654808418
0.14026225839173848
0.14112102023539277
0.14197978207904707
0.14283854392270137
    ];

Y_inv = 1./Y;
Y = Y_inv(end:-1:1);
Y = Y';

X = log(exp(Y)-1); 

I_base = [3.97698535404797671
4.28322529878643365
4.96547755273682245
6.35962395754328824
9.50752670221453400
19.40569864491534702
]';

I_base_inv = [
5001.56961510381825065
1385.86376485398932346
647.10275940778387849
391.46170510567787915
280.98778347475325745
228.87352439884492128
    ]';

I_base = I_base_inv(end:-1:1);

 C1 = (k+1)*k*(pi^2)/6;
 z = ((I_base*(k+1)./(y0.^(k+1)) - 1).*(y0.^2))/C1;

I_add = [3.97698535404797981
4.00246979740233133
4.02838709740040279
4.05474905447206257
4.08156791273114106
4.10885638131011444
4.13662765694841106
4.16489544792161404
4.19367399940589802
4.22297812037976517
4.25282321217357229
4.28322529878643632
4.33529438754189389
4.38904637671968612
4.44456920964226754
4.50195722211141014
4.56131174212618262
4.62274175901640039
4.68636467160973869
4.75230712661195742
4.82070596023310483
4.89170925830026349
4.96547755273682245
5.06039730987656355
5.16013540363538237
5.26509036068381242
5.37570702581988780
5.49248358982331819
5.61597994929242716
5.74682770468289750
5.88574218640343627
6.03353700918330382
6.19114180188467955
6.35962395754328735
6.54021551693151970
6.73434666790421854
6.94368785595012206
7.17020322445731928
7.41621913658212062
7.68451303030690713
7.97843007150011729
8.30203839658506126
8.66033883919639891
9.05955303908206133
9.50752670221453400
9.91393043247701122
10.36584125925828914
10.87179696144304231
11.44267483400500574
12.09256699932484125
12.84008596309485917
13.71037189855126037
14.73829015009028609
15.97374287595026487
17.49094949740193528
19.40569864491534702
20.81692691956601493
22.49974090741302035
24.54622921463951357
27.09703878971623681
30.37912883031857092
34.78604112278246419
41.07065862657648125
50.89560335997177987
68.89594037457331410
115.72079047064163149
]';

I_add_inv = [  
9131.76721088313752261
6657.07143171844472818
5001.56961510382370761
4338.65485058969534293
3787.90304945474917986
3326.56118397123873365
2937.19766620447944661
2606.30515009475129773
2323.30734474094879261
2079.84302289767310867
1869.24313963083932322
1686.14438783971422708
1526.20041114035325336
1385.86376485399159719
1282.12873032022662301
1188.49452426620746337
1103.76107969619215510
1026.89543769242459348
957.00521754840713129
893.31679330923611815
835.15725788461577395
781.93945096990853472
733.14947747562973746
688.33625992534291527
647.10275940778331005
615.94989122518563818
586.76546483347101457
559.39643707059565259
533.70382422770228459
509.56121797981677446
486.85347768294587922
465.47557580430373037
445.33157660385541021
426.33373101263839544
408.40167304453171937
391.46170510567765177
379.24422853914222742
367.53012724361343544
356.29374353890210614
345.51097324736372229
335.15915705496632881
325.21698046895852485
315.66438161436423115
306.48246618502980709
297.65342893067668228
289.16048112026948047
280.98778347475274586
275.63282474208511985
270.41316468150694163
265.32455762248582687
260.36291677131947608
255.52430731797170438
250.80493988259965477
246.20116428305271938
241.70946360576738243
237.32644856354224316
233.04885212467183919
228.87352439884423916
    ]';

I_add = I_add_inv(end:-1:1);
I = ((I_add*(k+1)./(Y.^(k+1)) - 1).*(Y.^2))/C1;

% Задаем матрицы A и B
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j < N + 1)
            A(i,j) = y0(i)^(-2*j);
        elseif (j <= baseSize)
            A(i,j) = -z(i)*y0(i)^(-2*(j-N));
        end
    end
end
disp('A matrix: ')
disp(A); 
disp('B matrix: ')
disp(B');
E = A\B';
% disp(E);

for j = 1:length(E)
    if (j > 0 && j < N + 1)
        a(j) = E(j);
    elseif (j > N && j <= baseSize)
        b(j-N) = E(j);
    end
end
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a');
disp('----------------------------');
disp('Коэффициенты b:'); disp(b');
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*y0(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^(-2*m);
    end
    F_base(j) = (1 + S1)/(1 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*Y(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^(-2*m);
    end
    F(j) = (1 + S1)/(1 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));
disp('-------------------');
disp('Экстремумы Z:');
disp(max(abs(delta_additional(1:11))));
disp(max(abs(delta_additional(11:22))));
disp(max(abs(delta_additional(22:33))));
disp(max(abs(delta_additional(33:44))));
disp(max(abs(delta_additional(44:55))));
disp(max(abs(delta_additional(55:end))));
disp('-------------------');

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
% line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');

app_I_base = zeros(1,length(F_base));
delta_base_I = zeros(1,length(F_base));
for i=1:length(F_base)
    app_I_base(i) = (F_base(i)*(C1/(y0(i)^2)) + 1)*((y0(i)^(k + 1))/(k+1));
    delta_base_I(i) = app_I_base(i)/I_base(i)-1;
end

app_I = zeros(1,length(Y));
delta_additional_I = zeros(1,length(Y));
for i=1:length(app_I)
    app_I(i) = (F(i)*(C1/(Y(i)^2)) + 1)*((Y(i)^(k + 1))/(k+1));
    delta_additional_I(i) = app_I(i)/I_add(i)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional_I))));
disp('-------------------');
disp('Экстремумы I:');
disp(max(abs(delta_additional_I(1:11))));
disp(max(abs(delta_additional_I(11:22))));
disp(max(abs(delta_additional_I(22:33))));
disp(max(abs(delta_additional_I(33:44))));
disp(max(abs(delta_additional_I(44:55))));
disp(max(abs(delta_additional_I(55:end))));
disp('-------------------');

figure
grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional_I, 'k','linewidth', 2.5);
plot(y0,delta_base_I, 'k*','linewidth',5)