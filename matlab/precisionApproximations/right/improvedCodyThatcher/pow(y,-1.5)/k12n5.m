%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 5;
baseSize = 2*N;
x_star = 3;
y_star = log(1+exp(x_star));

y_star_inv = 1/y_star^(3/2);

a = zeros(1,N); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:baseSize;
alpha = 2/(2+pi);
% y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
y0_inv = 0.5*y_star_inv*(2*alpha*j/baseSize + (1-alpha)*(1 - cos(pi*j/baseSize)));
y0 = 1./(y0_inv(end:-1:1)).^(2/3);
x0 = log(exp(y0)-1);

Y = [3.04858735157374294
3.05857779743344649
3.06865049624407060
3.07880653690830597
3.08904702824892263
3.09937309947489181
3.10978590066082150
3.12028660324015084
3.13087640051257265
3.14155650816617049
3.15232816481477052
3.16319263255103644
3.17997740544877372
3.19698662681353740
3.21422513766796092
3.23169792377449605
3.24941012118845585
3.26736702207189955
3.28557408078289503
3.30403692025564411
3.32276133868793133
3.34175331655349028
3.36101902395799623
3.38636547786035047
3.41219526398388862
3.43852329974030413
3.46536514301504672
3.49273702758023674
3.52065590091371305
3.54913946461889429
3.57820621765845415
3.60787550263513301
3.63816755537553860
3.66910355809778022
3.70598795319372609
3.74381351557234954
3.78261926766741885
3.82244649172886541
3.86333889905547156
3.90534281486785684
3.94850738055052863
3.99288477521518459
4.03853045879413219
4.08550343916816239
4.13386656617413628
4.18745809925535539
4.24282100182046573
4.30005084934998827
4.35925045449865411
4.42053057928396775
4.48401073421154450
4.54982007709737335
4.61809842654951730
4.68899740771365359
4.76268175106856440
4.83933076890510705
4.91914003879456541
5.00232332905195332
5.08911480818524975
5.17977158892483391
5.27457666807806458
5.37384233671076217
5.47791415175227581
5.58717558101947365
5.70205346014076841
5.82302443365315980
5.95062259596535892
6.07585520523541778
6.20789168622729282
6.34734343334531204
6.49490002015607093
6.65134238279029688
6.81755880416737270
6.99456442638409470
7.18352524463817943
7.38578784484744499
7.60291657396995380
7.83674042959627037
8.05237589897489414
8.28348430538491343
8.53192209268365787
8.79986641548432402
9.08988914560045203
9.40505269589441006
9.74903564435385306
10.12629969559307952
10.54231497087267222
11.00386917797385422
11.51949999136395597
11.96181885506002551
12.44919710092021070
12.98945815619587663
13.59242351024203543
14.27061091237261259
15.04025286373527415
15.92282353214202040
16.94740160682227881
18.15446527323367576
19.60226323992755582
21.37810018060957518
22.78055137027824983
24.43820058162986797
26.43448821595645271
28.89563246224706106
32.02310193212866807
36.16187120959530432
41.96213440225024982
50.83350569434592359
66.61073629296301135
105.73795286382581082
]';

X = log(exp(Y)-1); 

I_base = [3.97698535404797671
4.17634706453202575
4.52859424978253244
5.09733321181021193
6.00064043123520374
7.47184943859957507
10.01893277264426629
14.92328473597079963
26.30909875988677982
66.07473430706565409
]';

C1 = (k+1)*k*(pi^2)/6;
z = ((I_base*(k+1)./(y0.^(k+1)) - 1).*(y0.^2))/C1;

I_add = [3.97698535404797804
3.99422600484792945
4.01163538727777080
4.02921602825943737
4.04697050550202597
4.06490144878255677
4.08301154126570331
4.10130352086370564
4.11978018163809789
4.13844437524459163
4.15729901242274202
4.17634706453202575
4.20583591803162982
4.23579465991493365
4.26623476815457003
4.29716809795442600
4.32860689735161497
4.36056382359794981
4.39305196036662604
4.42608483583294898
4.45967644168131727
4.49384125309416582
4.52859424978253156
4.57446287301075838
4.62137736082856065
4.66937431895157040
4.71849208143852650
4.76877081371739919
4.82025262305656454
4.87298167711559405
4.92700433127258997
4.98236926549468251
5.03912763159554355
5.09733321181021370
5.16704758379677820
5.23889794174091339
5.31298484285664419
5.38941524905037728
5.46830304390460498
5.54976960046969303
5.63394440577959266
5.72096574880748499
5.81098147950119337
5.90414984760750361
6.00064043123520907
6.10822905588336429
6.22010663393676921
6.33653612732159299
6.45780239053741312
6.58421449182045837
6.71610833557889197
6.85384963269545988
6.99783727371321440
7.14850717009145686
7.30633664105646563
7.47184943859957773
7.64562152156197428
7.82828771234698984
8.02054939771798736
8.22318346980000392
8.43705274666536198
8.66311816618838648
8.90245311542411422
9.15626034489084084
9.42589202856907171
9.71287367394642231
10.01893277264427162
10.32263390129813807
10.64635608600877070
10.99214187225216932
11.36232064991677326
11.75956078659448423
12.18693355820606605
12.64799211395375345
13.14686976916023120
13.68840338060748074
14.27828960422430349
14.92328473597080674
15.52693788393403018
16.18317289480338061
16.89914980664188704
17.68338866719108537
18.54610848784485455
19.49967289259765124
20.55918381361593816
21.74328397380799061
23.07525914898091912
24.58457952981270722
26.30909875988678692
27.81998914054903693
29.51783331377552955
31.43955042607370842
33.63246232830814364
36.15823493813489620
39.09875837878836791
42.56517786524721458
46.71223806382698029
51.76198469024266302
58.04481318894791997
66.07473430706563988
72.65877143771766100
80.70679459029339853
90.76786722362514581
103.70481975422256937
120.95572923027033596
145.10917986178031924
181.34242701628184591
241.73592589885288362
362.53158867068543714
724.94158118433040272
]';

I = ((I_add*(k+1)./(Y.^(k+1)) - 1).*(Y.^2))/C1;

% Задаем матрицы A и B
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j > 0 && j < N + 1)
            A(i,j) = y0(i)^(-2*j);
        elseif (j >= N+1 && j <= baseSize)
            A(i,j) = -z(i)*y0(i)^(-2*(j-N));
        end
    end
end
disp('A matrix: ')
disp(A); 
disp('B matrix: ')
disp(B');
E = A\B';
% disp(E);

for j = 1:length(E)
    if (j > 0 && j < N + 1)
        a(j) = E(j);
    elseif (j > N && j <= baseSize)
        b(j-N) = E(j);
    end
end
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a');
disp('----------------------------');
disp('Коэффициенты b:'); disp(b');
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*y0(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^(-2*m);
    end
    F_base(j) = (1 + S1)/(1 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*Y(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^(-2*m);
    end
    F(j) = (1 + S1)/(1 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));
disp('-------------------');
disp('Экстремумы:');
disp(max(abs(delta_additional(1:11))));
disp(max(abs(delta_additional(11:22))));
disp(max(abs(delta_additional(22:33))));
disp(max(abs(delta_additional(33:44))));
disp(max(abs(delta_additional(44:55))));
disp(max(abs(delta_additional(55:66))));
disp(max(abs(delta_additional(66:77))));
disp(max(abs(delta_additional(77:88))));
disp(max(abs(delta_additional(88:99))));
disp(max(abs(delta_additional(99:end))));
disp('-------------------');

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
% line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');