%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 4;
baseSize = 2*N;
x_star = 3;
y_star = log(1+exp(x_star));

y_star_inv = 1/y_star^(3/2);

a = zeros(1,N); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:baseSize;
alpha = 2/(2+pi);
% y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
y0_inv = 0.5*y_star_inv*(2*alpha*j/baseSize + (1-alpha)*(1 - cos(pi*j/baseSize)));
y0 = 1./(y0_inv(end:-1:1)).^(2/3);
x0 = log(exp(y0)-1);

Y = [3.04858735157374428
3.06194056093598643
3.07544095952503405
3.08909116051725352
3.10289384130833312
3.11685174553546140
3.13096768517735402
3.14524454273566523
3.15968527350154460
3.17429290791125274
3.18907055399499662
3.20402139992334734
3.22827779285700611
3.25299854991254112
3.27819806007149728
3.30389133258692169
3.33009403141889226
3.35682251201941506
3.38409386065756390
3.41192593649379194
3.44033741663233661
3.46934784440286137
3.49897768114712759
3.53803782746238005
3.57820664782765574
3.61953536433984313
3.66207851046473731
3.70589420838335304
3.75104447506108585
3.79759556060446668
3.84561832298869133
3.89518864384440189
3.94638789070098861
3.99930343191594195
4.06074934131594389
4.12461112484823911
4.19104443302220542
4.26021904687955555
4.33232055215739997
4.40755226058638705
4.48613742239199986
4.56832178335236971
4.65437655132542449
4.74460185163118009
4.83933076890510616
4.93893409614733780
5.04382594118265537
5.15447037864796798
5.27138938470475971
5.39517235574084530
5.52648759666933742
5.66609627648230418
5.81486949902390382
5.97380934068084635
6.14407498593474610
6.32701547909658668
6.50227035603386838
6.69018816161810737
6.89229924682161510
7.11040035379870350
7.34661657955113512
7.60348176059500869
7.88404407865770906
8.19200674366523529
8.53191831615489171
8.90943464601461343
9.33168639137886302
9.69659629752147545
10.09940713402877677
10.54683677354500304
11.04735716335019902
11.61182202646677730
12.25439003046488828
12.99392191162120902
13.85616642896749795
14.87731730483734083
16.11007911978178342
17.63462151493512664
18.79149213084746606
20.15887352581495051
21.80559501036600167
23.83577294527722756
26.41559715486254589
29.82963437655941163
34.61422445824751293
41.93214671199698529
54.94665631808548056
87.22238004146400669
]';

X = log(exp(Y)-1); 

I_base = [3.97698535404797671
4.24820738426764422
4.78026107971192360
5.73359263923347129
7.47184943859957507
10.94148976809960594
19.27621605112203795
49.56582872854519195
]';

C1 = (k+1)*k*(pi^2)/6;
z = ((I_base*(k+1)./(y0.^(k+1)) - 1).*(y0.^2))/C1;

I_add = [3.97698535404798070
4.00003512517592341
4.02338701061963455
4.04704707998350788
4.07102156679869154
4.09531687408781497
4.11993958015758643
4.14489644463018259
4.17019441472502805
4.19584063180306721
4.22184243818652583
4.24820738426764599
4.29110689629176800
4.33498628901416616
4.37987997769627313
4.42582400935275366
4.47285616045796797
4.52101604174547322
4.57034521070787125
4.62088729246432095
4.67268810972996729
4.72579582269595200
4.78026107971192360
4.85240550595145503
4.92700513237023152
5.00418876892687869
5.08409439003504815
5.16686996255495767
5.25267436503658125
5.34167841015177913
5.43406598407027008
5.53003531866863085
5.62980041497629813
5.73359263923347218
5.85498390574065919
5.98213040627979442
6.11545381117255804
6.25541792069604341
6.40253404821790628
6.55736724900803569
6.72054355375803958
6.89275840095142467
7.07478650630704298
7.26749346318647671
7.47184943859957684
7.68894541993931391
7.92001258415231479
8.16644551233318872
8.42983017059333406
8.71197783900222156
9.01496651760277423
9.34119180485475376
9.69342987659885047
10.07491606144892771
10.48944371263780084
10.94148976809960594
11.38092574105810684
11.85895252780599662
12.38087161268401637
12.95299967002006269
13.58292360070838178
14.27983651976289181
15.05498634955093706
15.92228365736883333
16.89913884087088647
18.00763640175307501
19.27621605112203085
20.39641385339501767
21.65812244837416145
23.08988600848917727
24.72847355083552401
26.62207117154150637
28.83508610513786152
31.45559928013132378
34.60734211147204320
38.46976235211217698
43.31336104064244097
49.56582872854519195
54.49656105640964654
60.52397424830786576
68.05939848293759553
77.74922782192246018
90.67081472146028887
108.76344372477191769
135.90577963361059233
181.14825241109338094
271.64275355219143648
543.15160818266997467
]';

I = ((I_add*(k+1)./(Y.^(k+1)) - 1).*(Y.^2))/C1;

% Задаем матрицы A и B
B = z(1,:) - ones(1,baseSize);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j > 0 && j < N + 1)
            A(i,j) = y0(i)^(-2*j);
        elseif (j >= N+1 && j <= baseSize)
            A(i,j) = -z(i)*y0(i)^(-2*(j-N));
        end
    end
end
disp('A matrix: ')
disp(A); 
disp('B matrix: ')
disp(B');
E = A\B';
% disp(E);

for j = 1:length(E)
    if (j > 0 && j < N + 1)
        a(j) = E(j);
    elseif (j > N && j <= baseSize)
        b(j-N) = E(j);
    end
end
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a');
disp('----------------------------');
disp('Коэффициенты b:'); disp(b');
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*y0(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^(-2*m);
    end
    F_base(j) = (1 + S1)/(1 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N
        S1 = S1 + a(n).*Y(j).^(-2*n);
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^(-2*m);
    end
    F(j) = (1 + S1)/(1 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));
disp('-------------------');
disp('Экстремумы:');
disp(max(abs(delta_additional(1:11))));
disp(max(abs(delta_additional(11:22))));
disp(max(abs(delta_additional(22:33))));
disp(max(abs(delta_additional(33:44))));
disp(max(abs(delta_additional(44:55))));
disp(max(abs(delta_additional(55:66))));
disp(max(abs(delta_additional(66:77))));
disp(max(abs(delta_additional(77:end))));
disp('-------------------');

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
% line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');