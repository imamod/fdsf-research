%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 7/2;

N = 4;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.01992070521711391
0.03984141043422781
0.05976211565134172
0.07968282086845563
0.09960352608556954
0.11952423130268344
0.13944493651979734
0.15936564173691126
0.17928634695402518
0.19920705217113910
0.21912775738825302
0.25095745333880926
0.28278714928936549
0.31461684523992173
0.34644654119047796
0.37827623714103420
0.41010593309159044
0.44193562904214667
0.47376532499270291
0.50559502094325914
0.53742471689381544
0.56925441284437173
0.61019885569468346
0.65114329854499520
0.69208774139530693
0.73303218424561867
0.77397662709593040
0.81492106994624214
0.85586551279655387
0.89680995564686561
0.93775439849717734
0.97869884134748908
1.01964328419780093
1.06552059252408005
1.11139790085035917
1.15727520917663829
1.20315251750291741
1.24902982582919653
1.29490713415547565
1.34078444248175477
1.38666175080803389
1.43253905913431301
1.47841636746059213
1.52429367578687125
1.57017098411315037
1.61604829243942949
1.66192560076570861
1.70780290909198773
1.75368021741826685
1.79955752574454597
1.84543483407082509
1.89131214239710421
1.93718945072338333
1.98306675904966245
2.02894406737594135
2.06988851022625298
2.11083295307656460
2.15177739592687622
2.19272183877718785
2.23366628162749947
2.27461072447781110
2.31555516732812272
2.35649961017843435
2.39744405302874597
2.43838849587905759
2.47933293872936922
2.51116263467992562
2.54299233063048202
2.57482202658103843
2.60665172253159483
2.63848141848215123
2.67031111443270763
2.70214081038326404
2.73397050633382044
2.76580020228437684
2.79762989823493324
2.82945959418548965
2.84938029940260362
2.86930100461971760
2.88922170983683158
2.90914241505394555
2.92906312027105953
2.94898382548817350
2.96890453070528748
2.98882523592240146
3.00874594113951543
3.02866664635662941
3.04858735157374339
]';

X = log(exp(Y)-1); 

I_base = [2.81995112324957065
8.64977894571952000
19.32062487243159765
37.24367857481750121
64.18854255183470059
98.86887281584330367
134.97540628172603761
162.56644043989513193
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.23382813562896076
0.47193628947976002
0.71439760347885783
0.96128632862011665
1.21267783833918608
1.46864864197516676
1.72927639831877000
1.99463992924611078
2.26481923343730340
2.53989550017893517
2.81995112324957065
3.27797236865456787
3.74926755190732308
4.23419248452385677
4.73311130766927501
5.24639664213337653
5.77442973955752858
6.31760063488357293
6.87630829999481730
7.45096079851834858
8.04197544175710277
8.64977894571952177
9.45702559656996478
10.29372829795153521
11.16086659561945105
12.05944778848972732
12.99050750151250533
13.95511026243972097
14.95435008227267026
15.98935103917248313
17.06126786561366870
18.17128653855889908
19.32062487243159410
20.65668891700444476
22.04549617018409080
23.48890782663882604
24.98883926798661292
26.54726112955611583
28.16620036984159725
29.84774134215533437
31.59402686798466675
33.40725931156701023
35.28970165520061641
37.24367857481752253
39.27157751535161623
41.37584976544428628
43.55901153103978629
45.82364500743232583
48.17239944933859164
50.60799223858099793
53.13320994897952687
55.75090940806291684
58.46401875522402491
61.27553849595778956
64.18854255183474322
66.87659665962867450
69.65028012808045332
72.51193028980645749
75.46393354863920422
78.50872596032537842
81.64879381021796689
84.88667418785600205
88.22495555832537661
91.66627833030601380
95.21333542071208456
98.86887281584314735
101.78737503013883270
104.77446394849337707
107.83149736741042091
110.95985318308235890
114.16092954606227750
117.43614501509101444
120.78693871006746008
124.21477046415846246
127.72112097503870132
131.30749195525771711
134.97540628172609445
137.31315459730055295
139.68383000628492141
142.08781863146225533
144.52550991635433775
146.99729663922821032
149.50357492704998208
152.04474426938338638
154.62120753223652514
157.23337097185211064
159.88164424844705991
162.56644043989535930
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
%    F_base(j) = gamma(k+1)*y0(j)*((a0 + S1)/(b0 + S2))^k;
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
%     F(j) = gamma(k+1)*Y(j)*((a0 + S1)/(b0 + S2))^k;
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');