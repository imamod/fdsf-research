%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 7/2;

N = 3;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

a0 = 1; b0 = 1;
a = zeros(1,N+1); b = zeros(1,N);

% задаем лин-триг сетку 
j = 1:2*N;
alpha = 2/(2+pi);
y0 = 0.5*y_star*(2*alpha*j/(2*N)+(1-alpha)*(1 - cos(pi*j/(2*N))));
x0 = log(exp(y0)-1);

Y = [0.02931106723398783
0.05862213446797566
0.08793320170196349
0.11724426893595132
0.14655533616993915
0.17586640340392698
0.20517747063791480
0.23448853787190263
0.26379960510589046
0.29311067233987831
0.32242173957386616
0.37138048576234062
0.42033923195081513
0.46929797813928964
0.51825672432776415
0.56721547051623866
0.61617421670471317
0.66513296289318768
0.71409170908166220
0.76305045527013671
0.81200920145861122
0.86096794764708573
0.92127028656888443
0.98157262549068314
1.04187496441248184
1.10217730333428054
1.16247964225607925
1.22278198117787795
1.28308432009967666
1.34338665902147536
1.40368899794327406
1.46399133686507277
1.52429367578687147
1.58459601470867018
1.64489835363046888
1.70520069255226758
1.76550303147406629
1.82580537039586499
1.88610770931766369
1.94641004823946240
2.00671238716126110
2.06701472608305981
2.12731706500485851
2.18761940392665721
2.23657815011513161
2.28553689630360601
2.33449564249208041
2.38345438868055481
2.43241313486902921
2.48137188105750361
2.53033062724597801
2.57928937343445241
2.62824811962292681
2.67720686581140122
2.72616561199987562
2.75547667923386363
2.78478774646785165
2.81409881370183967
2.84340988093582769
2.87272094816981571
2.90203201540380373
2.93134308263779175
2.96065414987177977
2.98996521710576779
3.01927628433975581
3.04858735157374383
]';

X = log(exp(Y)-1); 

I_base = [4.35522217357415009
15.08135646072922675
37.24367857481750121
75.09104850948217802
123.36702994623477991
162.56644043989513193
]';

z = (I_base./(gamma(k+1)*y0)).^(1/k);

I_add = [0.34553153649178991
0.70040380471934671
1.06485229986393604
1.43911777462682156
1.82344633217443586
2.21808951995755077
2.62330442439180000
3.03935376638629506
3.46650599770661394
3.90503539815802103
4.35522217357415009
5.13395766133180231
5.94739000918183613
6.79694037798941242
7.68408023216149338
8.61033267815076186
9.57727381755149487
10.58653411411514078
11.63979977399289290
12.73881413849441380
13.88537908863508186
15.08135646072923386
16.62520271299361241
18.25065821979891467
19.96159666267138633
21.76204451865631029
23.65618520764645893
25.64836326009854162
27.74308850173789054
29.94504025186760288
32.25907153192476073
34.69021328096612677
37.24367857481752964
39.92486684568338262
42.73936809908553158
45.69296712508544545
48.79164770083476554
52.04159678160183233
55.44920867753003790
59.02108921350052384
62.76405986959409944
66.68516189977424347
70.79166042654615865
75.09104850948219223
78.72886332474179483
82.50315967608726453
86.41828991286276107
90.47871172070026091
94.68898950703494677
99.05379577655310186
103.57791249628679964
108.26623245010057417
113.12376058233800791
118.15561533042300368
123.36702994623476570
126.57518966091379298
129.85079189720229920
133.19501984518498716
136.60907197833390114
140.09416215158802288
143.65151969889066663
147.28238953018345114
150.98803222785520006
154.76972414264579925
158.62875748900341932
162.56644043989538773
]';

I = (I_add./(gamma(k+1)*Y)).^(1/k);

% Задаем матрицы A и B
B = z(1,:) - ones(1,2*N);
A = zeros(2*N,2*N);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j>=1 && j<=N)
            A(i,j) = (y0(i))^(j);
        elseif (j >= N+1 && j <=2*N-1)
            A(i,j) = -z(i)*y0(i)^(j-N);
        elseif (j == 2*N)
            A(i,j) = -z(i)*y0(i)^N + (gamma(k+2)^(-1/k))*(y0(i)^(N+1));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j>=1 && j<=N)
        a(j) = E(j);
    elseif (j >= N+1 && j <=2*N)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N)*gamma(k+2)^(-1/k);
disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a);
disp('----------------------------');
disp('Коэффициенты b:'); disp(b);
disp('----------------------------');

F_base = zeros(1,2*N);
delta_base = zeros(1,2*N);
for j = 1:2*N
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^m;
    end
    F_base(j) = (a0 + S1)/(b0 + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^n;
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^m;
    end
    F(j) = (a0 + S1)/(b0 + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('lg(dc):');disp(log10(max(abs(delta_additional))));

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');