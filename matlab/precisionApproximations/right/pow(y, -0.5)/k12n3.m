%% В этом файле значения z и I правильно аппроксимируются, т.е 
% z = (Ik/(k!*y))^(1/k)
%
clc 
clear all 
close all
format long

% коэффициент k функции Ферми-Дирака
k = 1/2;

N = 3;
% x_star = 2;
x_star = 3;
y_star = log(1+exp(x_star));

y_star_inv = 1/sqrt(y_star);

a_last = 1; b_last = 1;
a = zeros(1,N+1); b = zeros(1,N);

link_coefficient = (k+1)*(pi^2)/3;

% задаем лин-триг сетку
baseSize = 2*N;
j = 1:baseSize;
alpha = 2/(2+pi);
% y0 = 0.5*y_star*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
y0_inv = 0.5*y_star_inv*(2*alpha*j/(baseSize)+(1-alpha)*(1 - cos(pi*j/(baseSize))));
y0 = 1./(y0_inv(end:-1:1)).^2;
x0 = log(exp(y0)-1);

Y = [3.04858735157374738
3.10806590203110611
3.16930224350797296
3.23236632939363888
3.29733162786506817
3.36427533595562167
3.43327860899051140
3.50442680666269091
3.57780975714293703
3.65352204075055731
3.73166329485808435
3.81233854186610399
3.95304783881326260
4.10169351010117644
4.25888381649271164
4.42528642822981855
4.60163552663246200
4.78873991617839057
4.98749231478779986
5.19888002201880450
5.42399720378396388
5.66405907970922495
5.92041835751662493
6.26082381303080027
6.63145441968195470
7.03599735067917287
7.47871966703550406
7.96458130171219647
8.49937458579153571
9.08989768933887987
9.74417173614925680
10.47171462838924505
11.28388916367387473
12.19434940629497000
13.21961833273668141
14.37984280114324065
15.69979089747546830
17.21018484436044460
18.94950498993551236
20.96646522216355635
23.32346136524339997
26.10145549827585398
29.40702251731933359
33.38272630710929434
38.22275290177427109
42.97085837789371254
48.66193997505298796
55.56328944017695193
64.04407946630905712
74.62578059853746026
88.06428133356583032
105.48872393723308960
128.64667442410876674
160.36001108668313009
205.42711661582978877
272.55069679631702684
329.78634312354358826
407.14363348585629865
515.29116113053703430
673.03335331335460978
]';

X = log(exp(Y)-1); 

I_base = [3.97698535404797582
5.36997993447941901
9.94617499245650016
28.62575990670503501
157.67341776030775691
2999.76268642686591193
]';

z = (I_base*(k+1)./y0).^(2/k);

I_add = [3.97698535404798559
4.08001811959058536
4.18707234684977792
4.29835301326171759
4.41407775221415299
4.53447776090898724
4.65979878228926658
4.79030216785402896
4.92626602889554821
5.06798648448818323
5.21577901544796863
5.36997993447941901
5.64282558028478842
5.93638738635989593
6.25270532944205737
6.59406259776861781
6.96301960210428739
7.36245350971903267
7.79560434113280998
8.26612889464497869
8.77816404379685089
9.33640130268599044
9.94617499245650016
10.77713962631979783
11.70879068194591532
12.75679248117328690
13.93980038550430045
15.28015000691905989
16.80473508794789339
18.54613411249117405
20.54406760122757802
22.84729905476996592
25.51613696799306297
28.62575990670503501
32.27068167772540619
36.57081551804695607
41.67981130782218457
47.79667117979209223
55.18216856044759311
64.18242658402138545
75.26336892399127976
89.06202497408789043
106.46456338254570539
128.72779717745049766
157.67341776030795586
187.91436889122434195
226.42227866591443330
276.22579078664170993
341.78882445573515270
429.87113571180049121
551.03289133327996296
722.38039123401847519
972.83449481862169250
1353.85979993028240642
1962.94482717823188977
2999.76268642686454768
3992.66311614132291652
5476.88277189443306270
7798.11792311629324104
11640.31690945680202276
]';


I = (I_add*(k+1)./Y).^(2/k);

% Задаем матрицы A и B
B = (z(1,:) - ones(1,baseSize).*(y0.^2)).*y0.^(2*N) + link_coefficient*y0.^(2*N);
A = zeros(baseSize,baseSize);
for i = 1:size(A,2)
    for j = 1:size(A,2)
        if (j > 0 && j < N + 1)
            A(i,j) = (y0(i))^(2*(j-1));
        elseif (j >= N+1 && j <=baseSize-1)
            A(i,j) = -z(i)*y0(i)^(2*(j-N-1));
        elseif (j == baseSize)
            A(i,j) = -z(i)*y0(i)^(2*N-2) + (y0(i)^(2*N));
        end
    end
end
disp(A); 
disp(B');
E = A\B';
disp(E);

for j = 1:length(E)
    if (j > 0 && j <= N)
        a(j) = E(j);
    elseif (j >= N+1 && j <= baseSize)
        b(j-N) = E(j);
    end
end
a(N+1) = b(N) - link_coefficient;
% disp('lg(cond(A)):'); disp(log10(cond(A)));
disp('--------------------------------');
disp('Коэффициенты а:'); disp(a');
disp('----------------------------');
disp('Коэффициенты b:'); disp(b');
disp('----------------------------');

F_base = zeros(1,baseSize);
delta_base = zeros(1,baseSize);
for j = 1:baseSize
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*y0(j).^(2*(n-1));
    end
    for m = 1:N
        S2 = S2 + b(m).*y0(j).^(2*(m-1));
    end
    F_base(j) = (y0(j).^(2*N+2) + S1)/(y0(j).^(2*N) + S2);
    delta_base(j) = F_base(j)/z(j)-1;
end
%---------------------------------------
% Добавим вспомогательную сетку

F = zeros(1,length(Y));
delta_additional = zeros(1,length(Y));
for j = 1:length(Y)
    S1 = 0; S2 = 0; 
    for n = 1:N+1 
        S1 = S1 + a(n).*Y(j).^(2*(n-1));
    end
    for m = 1:N
        S2 = S2 + b(m).*Y(j).^(2*(m-1));
    end
    F(j) = (Y(j).^(2*N+2) + S1)/(Y(j).^(2*N) + S2);
    delta_additional(j) = F(j)/I(j)-1;
end

disp('-------------------');
disp('Экстремумы:');
disp(max(abs(delta_additional(1:11))));
disp(max(abs(delta_additional(11:22))));
disp(max(abs(delta_additional(22:33))));
disp(max(abs(delta_additional(33:44))));
disp(max(abs(delta_additional(44:55))));
disp(max(abs(delta_additional(55:end))));
disp('-------------------');

grid on, hold on
xlabel('y'); %ylabel('d*10^1^0');
plot(Y,delta_additional, 'k','linewidth', 2.5);
plot(y0,delta_base, 'k*','linewidth',5)
% axis([0 y_star -1.5*10^(-1) 1.5*10^(-1)])
% line([0;y_star],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;log(1+exp(x_star))],[0; 0],'linewidth', 2, 'color', 'black');
% line([0;0],[-1.25; 1.35],'linewidth', 3, 'color', 'black');
% title({'Линейно-тригонометрическая сетка';['k = ', num2str(k), ', N = ', num2str(N), ', x_d_i_v = ', num2str(x_div)]})
% plot(log(1+exp(x_div)),2*10^-16,'b*');